<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Check-in</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #DBEAFE;
            --success: #059669;
            --success-light: #ECFDF5;
            --danger: #DC2626;
            --warning: #D97706;
            --warning-light: #FFFBEB;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1e3a5f 0%, #2563EB 100%); color: var(--gray-800); min-height: 100vh; display: flex; flex-direction: column; }

        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--gray-200); padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
        .header img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header .stars { color: #F59E0B; font-size: 12px; margin-left: 8px; }

        .main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px; }
        .card { background: white; border-radius: 16px; box-shadow: var(--shadow-lg); max-width: 600px; width: 100%; overflow: hidden; }
        .card-wide { max-width: 700px; }
        .card-body { padding: 32px; }
        .card-header { padding: 24px 32px; border-bottom: 1px solid var(--gray-100); }
        .card-header h2 { font-size: 20px; font-weight: 600; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
        .btn-outline { background: white; border: 2px solid var(--gray-200); color: var(--gray-700); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-lg { padding: 16px 32px; font-size: 17px; border-radius: 12px; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200); border-radius: 8px; font-size: 15px; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .choice-grid { display: grid; gap: 16px; margin-top: 24px; }
        .choice-card { padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .choice-card:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow); }
        .choice-card.selected { border-color: var(--primary); background: var(--primary-light); }
        .choice-card i { font-size: 36px; color: var(--primary); display: block; margin-bottom: 12px; }
        .choice-card h3 { font-size: 16px; margin-bottom: 4px; }
        .choice-card p { font-size: 13px; color: var(--gray-500); }

        .summary-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        .summary-table td { padding: 8px 0; font-size: 14px; border-bottom: 1px solid var(--gray-100); }
        .summary-table td:last-child { text-align: right; font-weight: 500; }
        .summary-table tr.total td { border-top: 2px solid var(--gray-800); border-bottom: none; font-size: 16px; font-weight: 700; padding-top: 12px; }
        .summary-table tr.deposit td { color: var(--success); }
        .summary-table tr.remaining td { color: var(--primary); font-size: 18px; font-weight: 700; }

        .info-box { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px; margin: 16px 0; }
        .info-box.success { background: var(--success-light); border-color: #A7F3D0; }
        .info-box.warning { background: var(--warning-light); border-color: #FDE68A; }

        .breakfast-card { background: linear-gradient(135deg, #FFF7ED 0%, #FFFBEB 100%); border: 2px solid #FDE68A; border-radius: 14px; padding: 20px; margin: 20px 0; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .breakfast-card:hover { border-color: #F59E0B; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(245,158,11,0.2); }
        .breakfast-card .breakfast-icon { font-size: 48px; line-height: 1; margin-bottom: 4px; }
        .breakfast-card .breakfast-header { display: flex; align-items: center; gap: 14px; margin-bottom: 10px; }
        .breakfast-card .breakfast-header h4 { font-size: 17px; font-weight: 700; color: var(--gray-800); margin: 0; }
        .breakfast-card .breakfast-details { font-size: 13px; color: var(--gray-500); margin-bottom: 8px; }
        .breakfast-card .breakfast-price-tag { display: inline-flex; align-items: center; gap: 6px; background: #F59E0B; color: white; font-size: 15px; font-weight: 700; padding: 8px 16px; border-radius: 8px; }
        .breakfast-card .breakfast-action { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .breakfast-card .btn-breakfast { background: #F59E0B; color: white; border: none; padding: 10px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .breakfast-card .btn-breakfast:hover { background: #D97706; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
        .breakfast-card .btn-breakfast:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .breakfast-card .breakfast-badge { position: absolute; top: -1px; right: 16px; background: #EF4444; color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 0 0 8px 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        .breakfast-checkbox-card { display: flex; align-items: center; gap: 14px; padding: 16px 20px; background: linear-gradient(135deg, #FFF7ED 0%, #FFFBEB 100%); border: 2px solid #FDE68A; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 16px; }
        .breakfast-checkbox-card:hover { border-color: #F59E0B; background: linear-gradient(135deg, #FEF3C7 0%, #FFF7ED 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245,158,11,0.15); }
        .breakfast-checkbox-card.checked { border-color: #F59E0B; background: linear-gradient(135deg, #FEF3C7 0%, #FFF7ED 100%); box-shadow: 0 4px 12px rgba(245,158,11,0.15); }
        .breakfast-checkbox-card .bf-icon { font-size: 36px; line-height: 1; flex-shrink: 0; }
        .breakfast-checkbox-card .bf-content { flex: 1; }
        .breakfast-checkbox-card .bf-content strong { font-size: 15px; color: var(--gray-800); display: block; margin-bottom: 2px; }
        .breakfast-checkbox-card .bf-content span { font-size: 13px; color: var(--gray-500); }
        .breakfast-checkbox-card .bf-price { font-size: 15px; font-weight: 700; color: #D97706; white-space: nowrap; }
        .breakfast-checkbox-card input[type="checkbox"] { display: none; }
        .breakfast-checkbox-card .bf-check { width: 24px; height: 24px; border: 2px solid var(--gray-300); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .breakfast-checkbox-card.checked .bf-check { background: #F59E0B; border-color: #F59E0B; }
        .breakfast-checkbox-card.checked .bf-check::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 12px; }

        .locker-display { text-align: center; padding: 32px; background: linear-gradient(135deg, #1e3a5f, #2563EB); border-radius: 12px; color: white; margin: 20px 0; }
        .locker-display .locker-number { font-size: 48px; font-weight: 800; margin: 8px 0; }
        .locker-display .locker-code { font-size: 28px; font-weight: 700; letter-spacing: 4px; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 8px; display: inline-block; margin: 8px 0; }
        .locker-display .room-info { margin-top: 12px; font-size: 18px; }

        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--gray-300); transition: all 0.3s; }
        .step-dot.active { background: var(--primary); width: 28px; border-radius: 5px; }
        .step-dot.done { background: var(--success); }

        .alert { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin: 12px 0; }
        .alert-error { background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA; }
        .alert-info { background: #EFF6FF; color: var(--primary); border: 1px solid #BFDBFE; }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .consent-checkbox { display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .consent-checkbox:hover { border-color: var(--primary); background: var(--primary-light); }
        .consent-checkbox.checked { border-color: var(--primary); background: var(--primary-light); }
        .consent-checkbox input[type="checkbox"] { margin-top: 3px; min-width: 18px; min-height: 18px; accent-color: var(--primary); cursor: pointer; }
        .consent-checkbox label { font-size: 14px; color: var(--gray-600); cursor: pointer; line-height: 1.5; }

        #stripe-element { padding: 14px; border: 1.5px solid var(--gray-200); border-radius: 8px; background: white; }

        .back-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; }
        .back-link:hover { color: white; }

        .service-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .service-item:hover { border-color: var(--primary); background: var(--primary-light); }
        .service-item.selected { border-color: var(--primary); background: var(--primary-light); }
        .service-item .service-info { display: flex; align-items: center; gap: 10px; }
        .service-item .service-price { font-weight: 700; color: var(--primary); white-space: nowrap; }

        .rgpd-notice { background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 12px 14px; font-size: 12px; color: #0369A1; margin: 12px 0; }
        .rgpd-notice i { margin-right: 6px; }

        .editable-field { display: flex; align-items: center; gap: 8px; }
        .editable-field input, .editable-field select { flex: 1; }

        @media (max-width: 640px) {
            .card-body { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .locker-display .locker-number { font-size: 36px; }
            .choice-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header" id="hotel-header" style="display:none">
        <img id="hotel-logo" src="" alt="" onerror="this.style.display='none'">
        <div>
            <h1 id="hotel-name"></h1>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <span id="hotel-stars"></span>
                <span id="hotel-address-header" style="font-size:12px;color:var(--gray-500)"></span>
            </div>
        </div>
    </div>

    <div class="main">
        <div id="app">
            <div style="text-align:center;color:white">
                <div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div>
                <p>Chargement...</p>
            </div>
        </div>
    </div>

    <script>
    // ==================== CONFIG & STATE ====================
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? 'http://localhost:8000/api' : window.location.origin + '/api';

    let hotelSlug = new URLSearchParams(window.location.search).get('hotel');
    let hotel = null;
    let pricing = null;
    let stripe = null;
    let stripeElements = null;
    let cardElement = null;
    let currentReservation = null;
    let currentStep = 'welcome';
    let walkinBirthdate = null;
    let availableServices = [];
    let selectedServices = {};
    let walkinNbPersons = 1;
    let walkinAvailableRooms = [];
    let walkinSelectedRoomIds = [];
    let walkinMultiMode = false;
    let walkinRoomGroups = [];
    let lastLookupData = null;

    // ==================== API ====================
    async function apiGet(url) {
        const r = await fetch(API_BASE + url);
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Erreur serveur');
        return data;
    }

    async function apiPost(url, body) {
        const r = await fetch(API_BASE + url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Erreur serveur');
        return data;
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function fmtPrice(n) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0); }
    function fmtDate(d) { if (!d) return '-'; return new Date(d + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }

    const ROOM_TYPE_LABELS = {
        standard: 'Standard', superieure: 'Sup√©rieure', suite: 'Suite',
        triple: 'Triple', quadruple: 'Quadruple',
        familiale: 'Familiale', pmr: 'PMR'
    };
    const BED_TYPE_LABELS = {
        single: 'Simple', double: 'Double', twin: 'Twin (2 lits)',
        queen: 'Queen', king: 'King'
    };

    // ==================== INIT ====================
    async function init() {
        if (!hotelSlug) {
            showError('Aucun h√¥tel sp√©cifi√©. V√©rifiez le lien.');
            return;
        }

        try {
            const res = await apiGet(`/booking/${hotelSlug}`);
            hotel = res.hotel;
            pricing = res.pricing;

            // Init Stripe
            if (hotel.stripe_public_key) {
                stripe = Stripe(hotel.stripe_public_key);
            }

            // Load available services
            try {
                const svcRes = await apiGet(`/booking/${hotelSlug}/services`);
                availableServices = svcRes.services || [];
            } catch (e) { availableServices = []; }

            // Update header
            document.getElementById('hotel-header').style.display = 'flex';
            document.getElementById('hotel-name').textContent = hotel.name;
            if (hotel.logo_url) document.getElementById('hotel-logo').src = hotel.logo_url;
            if (hotel.stars) {
                document.getElementById('hotel-stars').innerHTML = Array(parseInt(hotel.stars)).fill('<i class="fas fa-star" style="color:#F59E0B;font-size:12px"></i>').join('');
            }
            if (hotel.address || hotel.city) {
                document.getElementById('hotel-address-header').innerHTML = '<i class="fas fa-map-marker-alt"></i> ' + esc((hotel.address || '') + (hotel.city ? ', ' + hotel.city : ''));
            }
            document.title = `Self Check-in - ${hotel.name}`;

            showWelcome();
        } catch (err) {
            showError(err.message);
        }
    }

    // ==================== VIEWS ====================

    function showError(msg) {
        document.getElementById('app').innerHTML = `
            <div class="card">
                <div class="card-body" style="text-align:center;padding:48px">
                    <i class="fas fa-exclamation-triangle" style="font-size:48px;color:var(--warning);margin-bottom:16px"></i>
                    <h2 style="margin-bottom:8px">Erreur</h2>
                    <p style="color:var(--gray-500)">${esc(msg)}</p>
                </div>
            </div>
        `;
    }

    function showWelcome() {
        currentStep = 'welcome';
        const addressParts = [];
        if (hotel.address) addressParts.push(esc(hotel.address));
        if (hotel.city) addressParts.push(esc(hotel.city));
        const fullAddress = addressParts.join(', ');

        document.getElementById('app').innerHTML = `
            <div class="card card-wide">
                <div class="card-body" style="text-align:center;padding:40px">
                    <i class="fas fa-door-open" style="font-size:48px;color:var(--primary);margin-bottom:16px"></i>
                    <h2 style="margin-bottom:8px">Bienvenue !</h2>
                    <p style="color:var(--gray-500);margin-bottom:8px">Self check-in ${esc(hotel.name)}</p>

                    ${fullAddress ? `
                    <p style="color:var(--gray-400);font-size:13px;margin-bottom:8px">
                        <i class="fas fa-map-marker-alt"></i> ${fullAddress}
                    </p>` : ''}

                    ${hotel.on_call_phone ? `
                    <div style="display:inline-flex;align-items:center;gap:6px;background:var(--warning-light);border:1px solid #FDE68A;border-radius:8px;padding:6px 14px;font-size:13px;color:var(--gray-700);margin-bottom:24px">
                        <i class="fas fa-phone-alt" style="color:var(--warning)"></i>
                        <span>N¬∞ d'astreinte : <strong>${esc(hotel.on_call_phone)}</strong></span>
                    </div>` : '<div style="margin-bottom:16px"></div>'}

                    <div class="choice-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="choice-card" onclick="showLookup()">
                            <i class="fas fa-search"></i>
                            <h3>J'ai une r√©servation</h3>
                            <p>Rechercher ma r√©servation et r√©cup√©rer ma cl√©</p>
                        </div>
                        ${hotel.walkin_enabled ? `
                        <div class="choice-card" onclick="showWalkinPersonCount()">
                            <i class="fas fa-walking"></i>
                            <h3>Sans r√©servation</h3>
                            <p>R√©server une chambre disponible maintenant</p>
                        </div>` : `
                        <div class="choice-card" style="opacity:0.4;cursor:default">
                            <i class="fas fa-walking"></i>
                            <h3>Sans r√©servation</h3>
                            <p>Non disponible actuellement</p>
                        </div>`}
                    </div>

                    <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--gray-200)">
                        <div class="choice-card" onclick="showUrgence()" style="border-color:#FECACA;background:#FEF2F2">
                            <i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i>
                            <h3 style="color:var(--danger)">Urgence</h3>
                            <p>Signaler un probl√®me urgent ou contacter l'astreinte</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== URGENCE ====================

    function showUrgence() {
        currentStep = 'urgence';
        const addressParts = [];
        if (hotel.address) addressParts.push(esc(hotel.address));
        if (hotel.city) addressParts.push(esc(hotel.city));
        const fullAddress = addressParts.join(', ');

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWelcome()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header" style="background:#FEF2F2;border-bottom-color:#FECACA">
                    <h2 style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> Urgence</h2>
                </div>
                <div class="card-body">
                    <p style="color:var(--gray-600);margin-bottom:20px">
                        Si vous rencontrez un probl√®me urgent pendant votre s√©jour, veuillez contacter l'astreinte de l'h√¥tel.
                    </p>

                    ${hotel.on_call_phone ? `
                    <div style="text-align:center;margin:24px 0">
                        <div style="background:linear-gradient(135deg, #DC2626, #B91C1C);color:white;border-radius:16px;padding:32px;display:inline-block;min-width:280px">
                            <i class="fas fa-phone-alt" style="font-size:36px;margin-bottom:12px;display:block"></i>
                            <p style="font-size:14px;opacity:0.9;margin-bottom:8px">N¬∞ d'astreinte</p>
                            <p style="font-size:28px;font-weight:800;letter-spacing:1px">${esc(hotel.on_call_phone)}</p>
                            <a href="tel:${esc(hotel.on_call_phone)}" class="btn" style="background:white;color:var(--danger);margin-top:16px;font-weight:700">
                                <i class="fas fa-phone"></i> Appeler maintenant
                            </a>
                        </div>
                    </div>` : `
                    <div class="info-box warning" style="text-align:center">
                        <i class="fas fa-info-circle" style="font-size:24px;color:var(--warning);margin-bottom:8px;display:block"></i>
                        <p>Aucun num√©ro d'astreinte n'est configur√© pour cet √©tablissement.</p>
                    </div>`}

                    ${hotel.phone ? `
                    <div style="text-align:center;margin:16px 0">
                        <p style="color:var(--gray-500);font-size:13px;margin-bottom:8px">Ou contactez la r√©ception :</p>
                        <a href="tel:${esc(hotel.phone)}" style="font-size:18px;font-weight:600;color:var(--primary);text-decoration:none">
                            <i class="fas fa-concierge-bell"></i> ${esc(hotel.phone)}
                        </a>
                    </div>` : ''}

                    ${fullAddress ? `
                    <div class="info-box" style="margin-top:20px">
                        <p style="font-weight:600;margin-bottom:4px"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> Adresse de l'h√¥tel</p>
                        <p style="color:var(--gray-600)">${fullAddress}</p>
                    </div>` : ''}

                    <div class="info-box" style="margin-top:16px">
                        <p style="font-weight:600;margin-bottom:8px"><i class="fas fa-list" style="color:var(--primary)"></i> Types d'urgences courants</p>
                        <ul style="list-style:none;padding:0;margin:0;font-size:14px;color:var(--gray-600)">
                            <li style="padding:6px 0;border-bottom:1px solid var(--gray-100)"><i class="fas fa-key" style="color:var(--warning);width:20px"></i> Probl√®me d'acc√®s chambre / casier</li>
                            <li style="padding:6px 0;border-bottom:1px solid var(--gray-100)"><i class="fas fa-bolt" style="color:var(--danger);width:20px"></i> Panne √©lectrique / eau</li>
                            <li style="padding:6px 0;border-bottom:1px solid var(--gray-100)"><i class="fas fa-tools" style="color:var(--gray-500);width:20px"></i> Probl√®me technique dans la chambre</li>
                            <li style="padding:6px 0;border-bottom:1px solid var(--gray-100)"><i class="fas fa-shield-alt" style="color:var(--primary);width:20px"></i> Probl√®me de s√©curit√©</li>
                            <li style="padding:6px 0"><i class="fas fa-first-aid" style="color:var(--danger);width:20px"></i> Urgence m√©dicale (appelez le 15 / 112)</li>
                        </ul>
                    </div>

                    <div style="margin-top:20px;text-align:center">
                        <button class="btn btn-outline" onclick="showWelcome()">
                            <i class="fas fa-arrow-left"></i> Retour √† l'accueil
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== FLOW A: WITH RESERVATION ====================

    function showLookup() {
        currentStep = 'lookup';
        document.getElementById('app').innerHTML = `
            <a href="javascript:showWelcome()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Rechercher votre r√©servation</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <form onsubmit="doLookup(event)">
                        <div class="form-group">
                            <label>Num√©ro de r√©servation</label>
                            <input type="text" id="lookup-number" placeholder="Ex: SC-A1B2C3-260211">
                        </div>
                        <p style="text-align:center;color:var(--gray-400);margin:12px 0">ou</p>
                        <div class="form-group">
                            <label>Nom de famille</label>
                            <input type="text" id="lookup-name" placeholder="Votre nom de famille">
                        </div>
                        <div id="lookup-error"></div>
                        <button type="submit" class="btn btn-primary btn-block btn-lg" id="lookup-btn">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    async function doLookup(e) {
        e.preventDefault();
        const number = document.getElementById('lookup-number').value.trim();
        const name = document.getElementById('lookup-name').value.trim();
        const errDiv = document.getElementById('lookup-error');
        const btn = document.getElementById('lookup-btn');

        if (!number && !name) {
            errDiv.innerHTML = '<div class="alert alert-error">Veuillez saisir un num√©ro de r√©servation ou votre nom.</div>';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Recherche...';
        errDiv.innerHTML = '';

        try {
            const body = {};
            if (number) body.reservation_number = number;
            else body.last_name = name;

            const res = await apiPost(`/booking/${hotelSlug}/lookup`, body);
            currentReservation = res.reservation;
            lastLookupData = res;
            showReservationDetails(res);
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-times-circle"></i> ${esc(err.message)}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Rechercher';
        }
    }

    function showReservationDetails(data) {
        currentStep = 'details';
        const r = data.reservation;
        const bfOption = data.breakfast_option;
        const canAddBreakfast = !r.breakfast_included && bfOption && bfOption.unit_price > 0;
        const nbPersons = r.nb_adults + r.nb_children;
        const maxAdults = r.room_max_adults || 10;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showLookup()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-clipboard-check"></i> Votre r√©servation</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                    </div>

                    <div class="info-box">
                        <p><strong>N¬∞ ${esc(r.reservation_number)}</strong></p>
                        <p style="margin-top:8px;font-size:13px;color:var(--gray-500)">
                            Arriv√©e : ${fmtDate(r.checkin_date)}
                            ${r.room_number ? ' | Chambre ' + esc(r.room_number) : ''}
                            ${maxAdults ? ' (max ' + maxAdults + ' personne(s))' : ''}
                        </p>
                    </div>

                    <h3 style="margin:20px 0 12px"><i class="fas fa-user-edit"></i> Vos informations <small style="font-weight:400;color:var(--gray-400)">(modifiable)</small></h3>
                    <form id="reservation-edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pr√©nom</label>
                                <input type="text" id="res-firstname" value="${esc(r.guest_first_name || '')}">
                            </div>
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" id="res-lastname" value="${esc(r.guest_last_name || '')}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="res-email" value="${esc(r.guest_email || '')}">
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone</label>
                                <input type="tel" id="res-phone" value="${esc(r.guest_phone || '')}" placeholder="+33 6 ...">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre de personnes</label>
                                <select id="res-adults" onchange="onResAdultsChange()">
                                    ${[1,2,3,4,5,6].map(n => `<option value="${n}" ${r.nb_adults === n ? 'selected' : ''} ${n > maxAdults ? 'disabled' : ''}>${n}${n > maxAdults ? ' (hors capacit√©)' : ''}</option>`).join('')}
                                </select>
                                ${maxAdults ? `<small style="color:var(--gray-500)">Capacit√© max de la chambre : ${maxAdults} personne(s)</small>` : ''}
                            </div>
                            <div class="form-group">
                                <label>Nombre d'enfants</label>
                                <select id="res-children">
                                    ${[0,1,2,3,4].map(n => `<option value="${n}" ${r.nb_children === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div id="res-capacity-warning"></div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="saveReservationEdits()" id="save-edits-btn" style="margin-bottom:16px">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                        <div id="res-edit-status"></div>
                    </form>

                    <h3 style="margin:20px 0 12px"><i class="fas fa-receipt"></i> D√©tail de la r√©servation</h3>
                    <table class="summary-table">
                        <tr><td>H√©bergement</td><td>${fmtPrice(r.accommodation_price)}</td></tr>
                        <tr><td>Taxe de s√©jour (${r.nb_adults} pers.)</td><td>${fmtPrice(r.tourist_tax_amount)}</td></tr>
                        <tr><td>ü•ê Petit-d√©jeuner ${r.breakfast_included ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : '<span style="color:var(--gray-400)">(non inclus)</span>'}</td><td>${r.breakfast_included ? fmtPrice(r.breakfast_price) : '-'}</td></tr>
                        <tr class="total"><td>Total</td><td>${fmtPrice(r.total_amount)}</td></tr>
                        ${r.deposit_amount > 0 ? `<tr class="deposit"><td>Arrhes vers√©es</td><td>- ${fmtPrice(r.deposit_amount)}</td></tr>` : ''}
                        <tr class="remaining"><td>Reste √† payer</td><td>${fmtPrice(r.remaining_amount)}</td></tr>
                    </table>

                    ${canAddBreakfast ? `
                    <div class="breakfast-card" id="breakfast-option">
                        <div class="breakfast-badge">Recommand√©</div>
                        <div class="breakfast-header">
                            <span class="breakfast-icon">ü•ê</span>
                            <div>
                                <h4>Petit-d√©jeuner gourmand</h4>
                                <p class="breakfast-details"><i class="fas fa-clock"></i> Servi de ${bfOption.start} √† ${bfOption.end} &bull; ${nbPersons} personne${nbPersons > 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <p style="font-size:13px;color:var(--gray-600);margin-bottom:12px"><i class="fas fa-utensils" style="color:#F59E0B;margin-right:6px"></i> Commencez votre journ√©e avec un d√©licieux petit-d√©jeuner : viennoiseries, boissons chaudes, fruits frais et plus encore !</p>
                        <div class="breakfast-action">
                            <span class="breakfast-price-tag"><i class="fas fa-tag"></i> + ${fmtPrice(bfOption.unit_price * nbPersons)}</span>
                            <button class="btn-breakfast" onclick="addBreakfast(${r.id})" id="add-breakfast-btn">
                                <i class="fas fa-plus-circle"></i> Ajouter le petit-d√©jeuner
                            </button>
                        </div>
                    </div>` : ''}

                    <div style="margin-top:24px">
                        ${r.remaining_amount > 0 ? `
                        <button class="btn btn-primary btn-block btn-lg" onclick="showPayment()">
                            <i class="fas fa-credit-card"></i> Payer ${fmtPrice(r.remaining_amount)}
                        </button>` : `
                        <button class="btn btn-success btn-block btn-lg" onclick="confirmNoPayment()">
                            <i class="fas fa-check"></i> Confirmer mon arriv√©e
                        </button>`}
                    </div>
                </div>
            </div>
        `;
    }

    function onResAdultsChange() {
        const maxAdults = currentReservation.room_max_adults || 10;
        const selected = parseInt(document.getElementById('res-adults').value);
        const warnDiv = document.getElementById('res-capacity-warning');
        if (selected > maxAdults) {
            warnDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> La chambre ne peut accueillir que ${maxAdults} personne(s) maximum.</div>`;
        } else {
            warnDiv.innerHTML = '';
        }
    }

    async function saveReservationEdits() {
        const btn = document.getElementById('save-edits-btn');
        const statusDiv = document.getElementById('res-edit-status');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="border-color:var(--gray-300);border-top-color:var(--primary)"></span> Enregistrement...';

        try {
            const updateData = {
                reservation_id: currentReservation.id,
                guest_first_name: document.getElementById('res-firstname').value.trim(),
                guest_last_name: document.getElementById('res-lastname').value.trim(),
                guest_email: document.getElementById('res-email').value.trim(),
                guest_phone: document.getElementById('res-phone').value.trim(),
                nb_adults: parseInt(document.getElementById('res-adults').value),
                nb_children: parseInt(document.getElementById('res-children').value)
            };

            const res = await apiPost(`/booking/${hotelSlug}/update-reservation`, updateData);
            currentReservation = { ...currentReservation, ...res.reservation };

            // Re-fetch full data
            const lookupRes = await apiPost(`/booking/${hotelSlug}/lookup`, {
                reservation_number: currentReservation.reservation_number
            });
            currentReservation = lookupRes.reservation;
            lastLookupData = lookupRes;
            showReservationDetails(lookupRes);

            statusDiv.innerHTML = '<div class="alert alert-info" style="margin-top:8px"><i class="fas fa-check-circle"></i> Modifications enregistr√©es</div>';
            setTimeout(() => { const s = document.getElementById('res-edit-status'); if (s) s.innerHTML = ''; }, 3000);
        } catch (err) {
            statusDiv.innerHTML = `<div class="alert alert-error" style="margin-top:8px">${esc(err.message)}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        }
    }

    async function addBreakfast(reservationId) {
        const btn = document.getElementById('add-breakfast-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';

        try {
            const res = await apiPost(`/booking/${hotelSlug}/update-reservation`, {
                reservation_id: reservationId,
                add_breakfast: true
            });
            currentReservation = { ...currentReservation, ...res.reservation };

            const lookupRes = await apiPost(`/booking/${hotelSlug}/lookup`, {
                reservation_number: currentReservation.reservation_number
            });
            currentReservation = lookupRes.reservation;
            lastLookupData = lookupRes;
            showReservationDetails(lookupRes);
        } catch (err) {
            alert('Erreur: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus"></i> Ajouter';
        }
    }

    async function confirmNoPayment() {
        try {
            const res = await apiPost(`/booking/${hotelSlug}/pay`, {
                reservation_id: currentReservation.id
            });
            if (res.no_payment_needed) {
                showConfirmation(res.reservation);
            }
        } catch (err) {
            alert('Erreur: ' + err.message);
        }
    }

    // ==================== PAYMENT ====================

    async function showPayment() {
        currentStep = 'payment';

        document.getElementById('app').innerHTML = `
            <a href="javascript:showReservationDetails(lastLookupData)" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-credit-card"></i> Paiement</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                    </div>

                    <div class="info-box">
                        <p style="font-size:13px;color:var(--gray-500)">R√©servation ${esc(currentReservation.reservation_number)}</p>
                        <p style="font-size:24px;font-weight:700;color:var(--primary);margin-top:4px">${fmtPrice(currentReservation.remaining_amount)}</p>
                    </div>

                    <div id="payment-error"></div>

                    <div class="form-group">
                        <label>Carte bancaire</label>
                        <div id="stripe-element"></div>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" id="pay-btn" onclick="processPayment()" disabled>
                        <i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}
                    </button>

                    <p style="text-align:center;font-size:12px;color:var(--gray-400);margin-top:12px">
                        <i class="fas fa-shield-alt"></i> Paiement s√©curis√© par Stripe
                    </p>
                </div>
            </div>
        `;

        try {
            const res = await apiPost(`/booking/${hotelSlug}/pay`, {
                reservation_id: currentReservation.id
            });

            if (res.no_payment_needed) {
                showConfirmation(res.reservation);
                return;
            }

            window._paymentIntentId = res.payment_intent_id;
            window._clientSecret = res.client_secret;

            stripeElements = stripe.elements({ clientSecret: res.client_secret });
            cardElement = stripeElements.create('payment');
            cardElement.mount('#stripe-element');
            cardElement.on('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.complete;
            });
        } catch (err) {
            document.getElementById('payment-error').innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
        }
    }

    async function processPayment() {
        const btn = document.getElementById('pay-btn');
        const errDiv = document.getElementById('payment-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement en cours...';
        errDiv.innerHTML = '';

        try {
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements: stripeElements,
                confirmParams: { return_url: window.location.href },
                redirect: 'if_required'
            });

            if (error) {
                errDiv.innerHTML = `<div class="alert alert-error">${esc(error.message)}</div>`;
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
                return;
            }

            if (paymentIntent.status === 'succeeded') {
                const confirmRes = await apiPost(`/booking/${hotelSlug}/confirm`, {
                    reservation_id: currentReservation.id,
                    payment_intent_id: paymentIntent.id
                });
                showConfirmation(confirmRes.reservation);
            }
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
        }
    }

    // ==================== FLOW B: WALK-IN ====================

    // Step 1: Ask number of persons FIRST
    function showWalkinPersonCount() {
        currentStep = 'walkin-persons';
        selectedServices = {};
        idDocumentPath = null;
        walkinSelectedRoomIds = [];
        walkinMultiMode = false;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWelcome()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-users"></i> Nombre de personnes</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <p style="color:var(--gray-500);margin-bottom:20px">Combien de personnes s√©journeront ?</p>

                    <div class="form-group">
                        <label>Nombre de personnes *</label>
                        <select id="walkin-nb-persons" style="font-size:18px;padding:14px">
                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}">${n} personne${n > 1 ? 's' : ''}</option>`).join('')}
                        </select>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" onclick="searchWalkinRooms()">
                        <i class="fas fa-search"></i> Rechercher les chambres disponibles
                    </button>
                </div>
            </div>
        `;
    }

    // Step 2: Search and show available rooms (no room number shown)
    async function searchWalkinRooms() {
        walkinNbPersons = parseInt(document.getElementById('walkin-nb-persons').value) || 1;
        walkinSelectedRoomIds = [];
        walkinRoomGroups = [];
        currentStep = 'walkin-rooms';

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-bed"></i> Chambres disponibles</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>
                    <div style="text-align:center;padding:20px">
                        <div class="spinner" style="width:30px;height:30px;border-color:var(--gray-300);border-top-color:var(--primary)"></div>
                        <p style="margin-top:8px;color:var(--gray-500)">Recherche des chambres pour ${walkinNbPersons} personne(s)...</p>
                    </div>
                </div>
            </div>
        `;

        try {
            const res = await apiGet(`/booking/${hotelSlug}/available-rooms?nb_persons=${walkinNbPersons}`);
            if (!res.rooms || res.rooms.length === 0) {
                document.getElementById('app').innerHTML = `
                    <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
                    <div class="card">
                        <div class="card-body" style="text-align:center;padding:48px">
                            <i class="fas fa-bed" style="font-size:48px;color:var(--gray-300);margin-bottom:16px"></i>
                            <h2>Aucune chambre disponible</h2>
                            <p style="color:var(--gray-500);margin-top:8px">D√©sol√©, il n'y a pas de chambre disponible pour ${walkinNbPersons} personne(s) cette nuit.</p>
                            <button class="btn btn-outline" style="margin-top:20px" onclick="showWalkinPersonCount()">Modifier le nombre de personnes</button>
                        </div>
                    </div>
                `;
                return;
            }

            pricing = res.pricing;
            walkinAvailableRooms = res.rooms;
            walkinMultiMode = !res.single_room_possible;
            showWalkinRoomSelection(res.rooms, res.pricing);
        } catch (err) {
            showError(err.message);
        }
    }

    function showWalkinRoomSelection(rooms, pricingData) {
        const isMulti = walkinMultiMode;

        // Build room groups for multi mode (group by room_type + bed_type + max_adults)
        if (isMulti) {
            walkinRoomGroups = [];
            const groupMap = {};
            rooms.forEach(r => {
                const key = (r.room_type || 'standard') + '|' + (r.bed_type || 'double') + '|' + (r.max_adults || 2);
                if (!(key in groupMap)) {
                    groupMap[key] = walkinRoomGroups.length;
                    walkinRoomGroups.push({
                        room_type: r.room_type || 'standard',
                        bed_type: r.bed_type || 'double',
                        max_adults: r.max_adults || 2,
                        rooms: [],
                        selectedCount: 0
                    });
                }
                walkinRoomGroups[groupMap[key]].rooms.push(r);
            });
        }

        let roomCardsHtml = '';
        if (isMulti) {
            // Grouped cards with quantity selectors (+/-)
            roomCardsHtml = walkinRoomGroups.map((g, idx) => `
                <div class="choice-card" id="room-group-${idx}" style="cursor:default">
                    <i class="fas fa-bed"></i>
                    <h3>${esc(ROOM_TYPE_LABELS[g.room_type] || g.room_type)}</h3>
                    <p>${esc(BED_TYPE_LABELS[g.bed_type] || g.bed_type)} - Max ${g.max_adults} personne(s)</p>
                    <p style="font-weight:600;color:var(--primary);margin-top:4px">${fmtPrice(pricingData.night_price)} / nuit</p>
                    <p style="font-size:12px;color:var(--gray-500);margin-top:2px">${g.rooms.length} disponible(s)</p>
                    <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:10px">
                        <button type="button" class="btn btn-outline" onclick="changeRoomTypeQty(${idx}, -1)" style="width:36px;height:36px;padding:0;font-size:18px;border-radius:50%;line-height:1;display:flex;align-items:center;justify-content:center">&minus;</button>
                        <span id="qty-${idx}" style="font-size:20px;font-weight:700;min-width:28px;text-align:center">0</span>
                        <button type="button" class="btn btn-primary" onclick="changeRoomTypeQty(${idx}, 1)" style="width:36px;height:36px;padding:0;font-size:18px;border-radius:50%;line-height:1;display:flex;align-items:center;justify-content:center">+</button>
                    </div>
                </div>`).join('');
        } else {
            // Single-room mode: individual clickable cards
            roomCardsHtml = rooms.map(r => {
                const tooSmall = r.max_adults < walkinNbPersons;
                return `
                <div class="choice-card" id="room-card-${r.id}" onclick="${tooSmall ? '' : `selectWalkinRoom(${r.id})`}" style="${tooSmall ? 'opacity:0.4;cursor:not-allowed' : ''}">
                    <i class="fas fa-bed"></i>
                    <h3>${esc(ROOM_TYPE_LABELS[r.room_type] || r.room_type)}</h3>
                    <p>${esc(BED_TYPE_LABELS[r.bed_type] || r.bed_type)} - Max ${r.max_adults} personne(s)</p>
                    <p style="font-weight:600;color:var(--primary);margin-top:4px">${fmtPrice(pricingData.night_price)} / nuit</p>
                    ${tooSmall ? '<p style="font-size:12px;color:var(--danger);margin-top:2px">Capacit√© insuffisante</p>' : ''}
                </div>`;
            }).join('');
        }

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-bed"></i> ${isMulti ? 'S√©lectionnez vos chambres' : 'Choisissez votre chambre'}</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <div class="info-box">
                        <p><strong>Tarif de la nuit :</strong> ${fmtPrice(pricingData.night_price)} / chambre</p>
                        <p style="font-size:13px;color:var(--gray-500);margin-top:4px">
                            Taxe de s√©jour : ${fmtPrice(pricingData.tourist_tax)} / personne |
                            Petit-d√©jeuner : ${fmtPrice(pricingData.breakfast_price)} / pers (${pricingData.breakfast_start} - ${pricingData.breakfast_end})
                        </p>
                        <p style="font-size:13px;color:var(--primary);margin-top:4px;font-weight:600">
                            <i class="fas fa-users"></i> ${walkinNbPersons} personne(s)
                        </p>
                        ${isMulti ? `
                        <div class="alert alert-info" style="margin-top:8px;margin-bottom:0">
                            <i class="fas fa-info-circle"></i> S√©lectionnez le nombre de chambres de chaque type pour accueillir vos ${walkinNbPersons} personnes.
                        </div>` : ''}
                    </div>

                    ${isMulti ? `<div id="multi-room-status" style="margin-top:12px"></div>` : ''}

                    <div class="choice-grid" style="margin-top:16px">
                        ${roomCardsHtml}
                    </div>

                    ${isMulti ? `
                    <button class="btn btn-primary btn-block btn-lg" id="multi-room-continue-btn" onclick="confirmMultiRoomSelection()" disabled style="margin-top:20px">
                        <i class="fas fa-arrow-right"></i> Continuer
                    </button>` : ''}
                </div>
            </div>
        `;

        if (isMulti) updateMultiRoomStatus();
    }

    function selectWalkinRoom(reservationId) {
        const room = walkinAvailableRooms.find(r => r.id === reservationId);
        if (room && room.max_adults < walkinNbPersons && !walkinMultiMode) return;
        walkinSelectedRoomIds = [reservationId];
        currentReservation = { id: reservationId };
        showWalkinIdUpload();
    }

    function changeRoomTypeQty(groupIdx, delta) {
        const group = walkinRoomGroups[groupIdx];
        if (!group) return;

        const newCount = group.selectedCount + delta;
        if (newCount < 0 || newCount > group.rooms.length) return;

        if (delta > 0) {
            // Add one room from this group (pick first unselected)
            for (const r of group.rooms) {
                if (!walkinSelectedRoomIds.includes(r.id)) {
                    walkinSelectedRoomIds.push(r.id);
                    break;
                }
            }
        } else {
            // Remove one room from this group (remove last selected)
            for (let i = group.rooms.length - 1; i >= 0; i--) {
                const pos = walkinSelectedRoomIds.indexOf(group.rooms[i].id);
                if (pos >= 0) {
                    walkinSelectedRoomIds.splice(pos, 1);
                    break;
                }
            }
        }

        group.selectedCount = newCount;

        // Update quantity display
        const qtyEl = document.getElementById('qty-' + groupIdx);
        if (qtyEl) qtyEl.textContent = newCount;

        // Update card visual (highlight if qty > 0)
        const card = document.getElementById('room-group-' + groupIdx);
        if (card) card.classList.toggle('selected', newCount > 0);

        updateMultiRoomStatus();
    }

    function updateMultiRoomStatus() {
        const statusDiv = document.getElementById('multi-room-status');
        const btn = document.getElementById('multi-room-continue-btn');
        if (!statusDiv || !btn) return;

        let totalCapacity = 0;
        walkinSelectedRoomIds.forEach(id => {
            const room = walkinAvailableRooms.find(r => r.id === id);
            if (room) totalCapacity += room.max_adults;
        });

        const nbRooms = walkinSelectedRoomIds.length;
        const isSufficient = totalCapacity >= walkinNbPersons && nbRooms > 0;

        if (nbRooms === 0) {
            statusDiv.innerHTML = `<p style="color:var(--gray-500);font-size:14px"><i class="fas fa-hand-pointer"></i> Utilisez les boutons + et ‚àí pour choisir le nombre de chambres</p>`;
        } else {
            const color = isSufficient ? 'var(--success)' : 'var(--warning)';
            // Build breakdown per room type
            const breakdown = walkinRoomGroups
                .filter(g => g.selectedCount > 0)
                .map(g => `${g.selectedCount}√ó ${ROOM_TYPE_LABELS[g.room_type] || g.room_type}`)
                .join(', ');
            statusDiv.innerHTML = `
                <div class="info-box" style="border-color:${color}">
                    <p style="font-weight:600">
                        <i class="fas fa-check-circle" style="color:${color}"></i>
                        ${nbRooms} chambre(s) s√©lectionn√©e(s) ‚Äî Capacit√© : ${totalCapacity} personne(s) / ${walkinNbPersons} n√©cessaire(s)
                    </p>
                    ${breakdown ? `<p style="font-size:13px;color:var(--gray-600);margin-top:4px"><i class="fas fa-door-open"></i> ${breakdown}</p>` : ''}
                    ${!isSufficient ? `<p style="font-size:13px;color:var(--warning);margin-top:4px"><i class="fas fa-exclamation-triangle"></i> Capacit√© insuffisante, veuillez ajouter d'autres chambres</p>` : ''}
                    <p style="font-size:13px;color:var(--gray-500);margin-top:4px">H√©bergement : ${fmtPrice(pricing.night_price * nbRooms)} (${nbRooms} √ó ${fmtPrice(pricing.night_price)})</p>
                </div>
            `;
        }

        btn.disabled = !isSufficient;
    }

    function confirmMultiRoomSelection() {
        currentReservation = { id: walkinSelectedRoomIds[0], ids: walkinSelectedRoomIds };
        showWalkinIdUpload();
    }

    // Step 3: V√©rification majorit√© et consentements
    function showWalkinIdUpload() {
        currentStep = 'walkin-id';
        document.getElementById('app').innerHTML = `
            <a href="javascript:searchWalkinRooms()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-check-circle"></i> V√©rification et consentements</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <p style="color:var(--gray-500);margin-bottom:16px">Veuillez renseigner votre date de naissance et accepter les conditions ci-dessous pour continuer.</p>

                    <div class="form-group" style="margin-bottom:20px">
                        <label>Date de naissance *</label>
                        <input type="date" id="walkin-birthdate" required max="${new Date().toISOString().split('T')[0]}" onchange="checkConsentForm()">
                        <small style="color:var(--gray-500)">Vous devez avoir au moins 18 ans</small>
                    </div>

                    <h3 style="font-size:15px;margin-bottom:12px;color:var(--gray-700)"><i class="fas fa-file-contract" style="color:var(--primary);margin-right:6px"></i>Consentements obligatoires</h3>

                    <div class="consent-checkbox" onclick="toggleConsent(this, 'consent-cgv')">
                        <input type="checkbox" id="consent-cgv" onchange="checkConsentForm()" onclick="event.stopPropagation()">
                        <label for="consent-cgv">J'accepte les <strong>conditions g√©n√©rales de vente</strong> de l'√©tablissement.</label>
                    </div>

                    <div class="consent-checkbox" onclick="toggleConsent(this, 'consent-majeur')">
                        <input type="checkbox" id="consent-majeur" onchange="checkConsentForm()" onclick="event.stopPropagation()">
                        <label for="consent-majeur">Je certifie √™tre <strong>majeur(e)</strong> (avoir au moins 18 ans).</label>
                    </div>

                    <div class="consent-checkbox" onclick="toggleConsent(this, 'consent-rgpd')">
                        <input type="checkbox" id="consent-rgpd" onchange="checkConsentForm()" onclick="event.stopPropagation()">
                        <label for="consent-rgpd">Je consens au <strong>traitement de mes donn√©es personnelles</strong> dans le cadre de cette r√©servation, conform√©ment au RGPD. Mes donn√©es seront utilis√©es uniquement pour la gestion de mon s√©jour.</label>
                    </div>

                    <div id="id-error"></div>

                    <button class="btn btn-primary btn-block btn-lg" id="id-continue-btn" onclick="validateIdAndContinue()" disabled>
                        <i class="fas fa-arrow-right"></i> Continuer
                    </button>
                </div>
            </div>
        `;
    }

    function toggleConsent(container, checkboxId) {
        const cb = document.getElementById(checkboxId);
        cb.checked = !cb.checked;
        container.classList.toggle('checked', cb.checked);
        checkConsentForm();
    }

    function checkConsentForm() {
        const birthdate = document.getElementById('walkin-birthdate').value;
        const cgv = document.getElementById('consent-cgv').checked;
        const majeur = document.getElementById('consent-majeur').checked;
        const rgpd = document.getElementById('consent-rgpd').checked;
        document.getElementById('id-continue-btn').disabled = !(birthdate && cgv && majeur && rgpd);
    }

    function validateIdAndContinue() {
        const birthdate = document.getElementById('walkin-birthdate').value;
        const errDiv = document.getElementById('id-error');
        const cgv = document.getElementById('consent-cgv').checked;
        const majeur = document.getElementById('consent-majeur').checked;
        const rgpd = document.getElementById('consent-rgpd').checked;

        errDiv.innerHTML = '';

        if (!birthdate) {
            errDiv.innerHTML = '<div class="alert alert-error">Veuillez saisir votre date de naissance.</div>';
            return;
        }

        const birth = new Date(birthdate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;

        if (age < 18) {
            errDiv.innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> Vous devez avoir au moins 18 ans pour effectuer un check-in.</div>';
            return;
        }

        if (!cgv || !majeur || !rgpd) {
            errDiv.innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> Veuillez accepter tous les consentements obligatoires.</div>';
            return;
        }

        walkinBirthdate = birthdate;
        showWalkinForm();
    }

    // Step 4: Guest info + services + recap
    function showWalkinForm() {
        currentStep = 'walkin-form';
        const p = pricing;
        const isMulti = walkinSelectedRoomIds.length > 1;
        const nbRooms = walkinSelectedRoomIds.length;

        // Build max persons based on total capacity of selected rooms
        let totalCapacity = 0;
        walkinSelectedRoomIds.forEach(id => {
            const room = walkinAvailableRooms.find(r => r.id === id);
            if (room) totalCapacity += room.max_adults;
        });
        const maxPersons = totalCapacity || 6;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinIdUpload()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-user"></i> Vos informations</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                    </div>

                    ${isMulti ? `
                    <div class="info-box" style="margin-bottom:16px">
                        <p style="font-weight:600"><i class="fas fa-door-open"></i> ${nbRooms} chambres s√©lectionn√©es</p>
                        <div style="margin-top:8px">
                            ${walkinSelectedRoomIds.map(id => {
                                const room = walkinAvailableRooms.find(r => r.id === id);
                                return room ? `<span style="display:inline-block;background:var(--primary-light);color:var(--primary);padding:4px 10px;border-radius:6px;font-size:13px;font-weight:500;margin:2px 4px 2px 0">${esc(ROOM_TYPE_LABELS[room.room_type] || room.room_type)} (max ${room.max_adults} pers.)</span>` : '';
                            }).join('')}
                        </div>
                        <p style="font-size:13px;color:var(--gray-500);margin-top:6px">Capacit√© totale : ${totalCapacity} personne(s)</p>
                    </div>` : ''}

                    <form onsubmit="submitWalkin(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pr√©nom *</label>
                                <input type="text" id="wi-firstname" required>
                            </div>
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" id="wi-lastname" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="wi-email" required>
                            </div>
                            <div class="form-group">
                                <label>T√©l√©phone *</label>
                                <input type="tel" id="wi-phone" required placeholder="+33 6 ...">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre de personnes *</label>
                                <select id="wi-adults" onchange="updateWalkinPricing()">
                                    ${Array.from({length: maxPersons}, (_, i) => i + 1).map(n => `<option value="${n}" ${n === walkinNbPersons ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                                <small style="color:var(--gray-500)">${isMulti ? `Capacit√© totale : ${maxPersons} personne(s) (${nbRooms} chambres)` : `Max ${maxPersons} personne(s) pour cette chambre`}</small>
                            </div>
                            <div class="form-group">
                                <label>Nombre d'enfants</label>
                                <select id="wi-children" onchange="updateWalkinPricing()">
                                    ${[0,1,2,3,4].map(n => `<option value="${n}">${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="breakfast-checkbox-card" id="wi-breakfast-card" onclick="toggleBreakfastCard()">
                            <span class="bf-icon">ü•ê</span>
                            <input type="checkbox" id="wi-breakfast" onchange="updateWalkinPricing()">
                            <div class="bf-content">
                                <strong><i class="fas fa-coffee" style="color:#F59E0B;margin-right:4px"></i> Petit-d√©jeuner gourmand</strong>
                                <span>${p.breakfast_start} √† ${p.breakfast_end} &bull; Viennoiseries, boissons chaudes, fruits frais...</span>
                            </div>
                            <div style="text-align:right">
                                <div class="bf-price">${fmtPrice(p.breakfast_price)} / pers</div>
                                <div class="bf-check"></div>
                            </div>
                        </div>

                        ${availableServices.length > 0 ? `
                        <h3 style="margin:20px 0 12px"><i class="fas fa-concierge-bell"></i> Services compl√©mentaires</h3>
                        <div id="services-list">
                            ${availableServices.map(s => `
                                <div class="service-item" id="svc-${s.id}" onclick="toggleService(${s.id}, '${esc(s.name)}', ${s.price})">
                                    <div class="service-info">
                                        <i class="fas fa-${esc(s.icon || 'concierge-bell')}" style="color:var(--primary);font-size:18px"></i>
                                        <div>
                                            <strong style="font-size:14px">${esc(s.name)}</strong>
                                            ${s.description ? `<br><small style="color:var(--gray-500)">${esc(s.description)}</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="service-price">${fmtPrice(s.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        <h3 style="margin:20px 0 12px"><i class="fas fa-receipt"></i> R√©capitulatif</h3>
                        <div id="walkin-pricing-summary"></div>

                        <div id="walkin-error"></div>

                        <button type="submit" class="btn btn-primary btn-block btn-lg" id="walkin-submit-btn">
                            <i class="fas fa-credit-card"></i> Proc√©der au paiement
                        </button>
                    </form>
                </div>
            </div>
        `;

        updateWalkinPricing();
    }

    function toggleService(id, name, price) {
        if (selectedServices[id]) {
            delete selectedServices[id];
            document.getElementById('svc-' + id).classList.remove('selected');
        } else {
            selectedServices[id] = { id, name, price, quantity: 1 };
            document.getElementById('svc-' + id).classList.add('selected');
        }
        updateWalkinPricing();
    }

    function toggleBreakfastCard() {
        const cb = document.getElementById('wi-breakfast');
        cb.checked = !cb.checked;
        const card = document.getElementById('wi-breakfast-card');
        card.classList.toggle('checked', cb.checked);
        updateWalkinPricing();
    }

    function updateWalkinPricing() {
        const p = pricing;
        const nbAdults = parseInt(document.getElementById('wi-adults').value) || 1;
        const nbChildren = parseInt(document.getElementById('wi-children').value) || 0;
        const nbPersons = nbAdults + nbChildren;
        const wantsBreakfast = document.getElementById('wi-breakfast').checked;
        const nbRooms = walkinSelectedRoomIds.length || 1;

        const accommodation = p.night_price * nbRooms;
        const touristTax = p.tourist_tax * nbAdults;
        const breakfast = wantsBreakfast ? p.breakfast_price * nbPersons : 0;

        let servicesTotal = 0;
        Object.values(selectedServices).forEach(s => { servicesTotal += s.price * s.quantity; });

        const total = accommodation + touristTax + breakfast + servicesTotal;

        document.getElementById('walkin-pricing-summary').innerHTML = `
            <table class="summary-table">
                <tr><td>${nbRooms > 1 ? `${nbRooms} chambres` : 'Chambre'} - 1 nuit</td><td>${fmtPrice(accommodation)}${nbRooms > 1 ? ` <small style="color:var(--gray-400)">(${nbRooms} √ó ${fmtPrice(p.night_price)})</small>` : ''}</td></tr>
                <tr><td>Taxe de s√©jour (${nbAdults} personne(s))</td><td>${fmtPrice(touristTax)}</td></tr>
                ${wantsBreakfast ? `<tr><td>Petit-d√©jeuner (${nbPersons} pers.)</td><td>${fmtPrice(breakfast)}</td></tr>` : ''}
                ${Object.values(selectedServices).map(s => `<tr><td><i class="fas fa-concierge-bell" style="color:var(--primary)"></i> ${esc(s.name)}</td><td>${fmtPrice(s.price)}</td></tr>`).join('')}
                <tr class="total"><td>Total √† payer</td><td>${fmtPrice(total)}</td></tr>
            </table>
        `;
    }

    async function submitWalkin(e) {
        e.preventDefault();
        const btn = document.getElementById('walkin-submit-btn');
        const errDiv = document.getElementById('walkin-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement...';
        errDiv.innerHTML = '';

        try {
            const svcArray = Object.values(selectedServices).map(s => ({ id: s.id, quantity: s.quantity }));

            const body = {
                guest_first_name: document.getElementById('wi-firstname').value.trim(),
                guest_last_name: document.getElementById('wi-lastname').value.trim(),
                guest_email: document.getElementById('wi-email').value.trim(),
                guest_phone: document.getElementById('wi-phone').value.trim(),
                nb_adults: parseInt(document.getElementById('wi-adults').value),
                nb_children: parseInt(document.getElementById('wi-children').value),
                breakfast: document.getElementById('wi-breakfast').checked ? 1 : 0,
                birthdate: walkinBirthdate,
                consent_cgv: true,
                consent_majeur: true,
                consent_rgpd: true,
                services: svcArray
            };

            // Multi-room ou single-room
            if (walkinSelectedRoomIds.length > 1) {
                body.reservation_ids = walkinSelectedRoomIds;
            } else {
                body.reservation_id = currentReservation.id;
            }

            const res = await apiPost(`/booking/${hotelSlug}/walkin`, body);

            currentReservation = {
                ...currentReservation,
                id: res.reservation_id,
                ids: res.reservation_ids || [res.reservation_id],
                remaining_amount: res.amount,
                nb_rooms: res.nb_rooms || 1,
                reservation_number: currentReservation.reservation_number || 'N/A'
            };
            window._paymentIntentId = res.payment_intent_id;
            window._clientSecret = res.client_secret;
            window._walkinPricingDetail = res.pricing_detail;

            showWalkinPayment(res);
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-credit-card"></i> Proc√©der au paiement';
        }
    }

    // Step 5: Payment (no room number shown yet)
    function showWalkinPayment(payData) {
        currentStep = 'walkin-payment';

        document.getElementById('app').innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-credit-card"></i> Paiement</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                    </div>

                    <div class="info-box">
                        <p style="font-size:24px;font-weight:700;color:var(--primary)">${fmtPrice(payData.amount)}</p>
                    </div>

                    <div id="payment-error"></div>

                    <div class="form-group">
                        <label>Carte bancaire</label>
                        <div id="stripe-element"></div>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" id="pay-btn" onclick="processWalkinPayment()" disabled>
                        <i class="fas fa-lock"></i> Payer ${fmtPrice(payData.amount)}
                    </button>

                    <p style="text-align:center;font-size:12px;color:var(--gray-400);margin-top:12px">
                        <i class="fas fa-shield-alt"></i> Paiement s√©curis√© par Stripe
                    </p>
                </div>
            </div>
        `;

        stripeElements = stripe.elements({ clientSecret: payData.client_secret });
        cardElement = stripeElements.create('payment');
        cardElement.mount('#stripe-element');
        cardElement.on('change', (e) => {
            document.getElementById('pay-btn').disabled = !e.complete;
        });
    }

    async function processWalkinPayment() {
        const btn = document.getElementById('pay-btn');
        const errDiv = document.getElementById('payment-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement en cours...';
        errDiv.innerHTML = '';

        try {
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements: stripeElements,
                confirmParams: { return_url: window.location.href },
                redirect: 'if_required'
            });

            if (error) {
                errDiv.innerHTML = `<div class="alert alert-error">${esc(error.message)}</div>`;
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
                return;
            }

            if (paymentIntent.status === 'succeeded') {
                const confirmBody = {
                    payment_intent_id: paymentIntent.id
                };
                // Multi-room ou single-room
                if (currentReservation.ids && currentReservation.ids.length > 1) {
                    confirmBody.reservation_ids = currentReservation.ids;
                } else {
                    confirmBody.reservation_id = currentReservation.id;
                }

                const confirmRes = await apiPost(`/booking/${hotelSlug}/confirm`, confirmBody);
                // Room number is revealed here after payment
                if (confirmRes.reservations && confirmRes.reservations.length > 1) {
                    showMultiRoomConfirmation(confirmRes.reservations);
                } else {
                    showConfirmation(confirmRes.reservation);
                }
            }
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-lock"></i> R√©essayer`;
        }
    }

    // ==================== CONFIRMATION ====================

    function showConfirmation(reservation) {
        currentStep = 'confirmation';
        const r = reservation;

        document.getElementById('app').innerHTML = `
            <div class="card card-wide">
                <div class="card-body" style="text-align:center;padding:40px">
                    <div style="width:64px;height:64px;border-radius:50%;background:var(--success-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                        <i class="fas fa-check" style="font-size:28px;color:var(--success)"></i>
                    </div>
                    <h2 style="color:var(--success);margin-bottom:4px">Paiement confirm√© !</h2>
                    <p style="color:var(--gray-500)">Votre check-in est valid√©. Bon s√©jour !</p>

                    <div class="locker-display">
                        <p style="font-size:14px;opacity:0.8">Votre casier</p>
                        <div class="locker-number">${esc(r.locker_number || '-')}</div>
                        <p style="font-size:14px;opacity:0.8;margin-top:8px">Code d'acc√®s</p>
                        <div class="locker-code">${esc(r.locker_code || '-')}</div>
                        <div class="room-info">
                            <i class="fas fa-bed"></i> Chambre <strong>${esc(r.room_number || '-')}</strong>
                        </div>
                    </div>

                    <div class="info-box" style="text-align:left">
                        <h4 style="margin-bottom:8px"><i class="fas fa-receipt"></i> R√©capitulatif</h4>
                        <table class="summary-table">
                            <tr><td>R√©servation</td><td>${esc(r.reservation_number)}</td></tr>
                            <tr><td>Client</td><td>${esc((r.guest_first_name || '') + ' ' + (r.guest_last_name || ''))}</td></tr>
                            <tr><td>H√©bergement</td><td>${fmtPrice(r.accommodation_price)}</td></tr>
                            <tr><td>Taxe de s√©jour (${r.nb_adults} pers.)</td><td>${fmtPrice(r.tourist_tax_amount)}</td></tr>
                            ${r.breakfast_included ? `<tr><td>Petit-d√©jeuner <i class="fas fa-check-circle" style="color:var(--success)"></i></td><td>${fmtPrice(r.breakfast_price)}</td></tr>` : ''}
                            <tr class="total"><td>Total pay√©</td><td>${fmtPrice(r.total_amount)}</td></tr>
                            ${r.deposit_amount > 0 ? `<tr class="deposit"><td>Dont arrhes</td><td>${fmtPrice(r.deposit_amount)}</td></tr>` : ''}
                        </table>
                        <p style="font-size:12px;color:var(--gray-500);margin-top:8px">${esc(r.hotel_name)} - ${esc(r.hotel_address || '')}, ${esc(r.hotel_city || '')}</p>
                    </div>

                    ${r.guest_email ? `
                    <div class="info-box success">
                        <p><i class="fas fa-envelope"></i> Une confirmation a √©t√© envoy√©e √† <strong>${esc(r.guest_email)}</strong></p>
                    </div>` : ''}

                    <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="downloadReceipt()">
                            <i class="fas fa-file-pdf"></i> T√©l√©charger le re√ßu
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimer
                        </button>
                    </div>

                    <div style="margin-top:32px;padding-top:24px;border-top:1px solid var(--gray-200)">
                        <p style="font-size:24px">Bon s√©jour ! &#127969;</p>
                    </div>
                </div>
            </div>
        `;

        window._confirmationData = r;
    }

    // Multi-room confirmation page
    function showMultiRoomConfirmation(reservations) {
        currentStep = 'confirmation';
        const primary = reservations[0]; // Contains full pricing
        const nbRooms = reservations.length;

        document.getElementById('app').innerHTML = `
            <div class="card card-wide">
                <div class="card-body" style="text-align:center;padding:40px">
                    <div style="width:64px;height:64px;border-radius:50%;background:var(--success-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                        <i class="fas fa-check" style="font-size:28px;color:var(--success)"></i>
                    </div>
                    <h2 style="color:var(--success);margin-bottom:4px">Paiement confirm√© !</h2>
                    <p style="color:var(--gray-500)">Votre check-in est valid√© pour ${nbRooms} chambres. Bon s√©jour !</p>

                    ${reservations.map((r, idx) => `
                    <div class="locker-display" style="margin-top:${idx === 0 ? '20' : '12'}px">
                        <p style="font-size:14px;opacity:0.8">Chambre ${idx + 1}</p>
                        <div class="room-info" style="margin-top:4px">
                            <i class="fas fa-bed"></i> Chambre <strong>${esc(r.room_number || '-')}</strong>
                        </div>
                        <p style="font-size:14px;opacity:0.8;margin-top:12px">Votre casier</p>
                        <div class="locker-number">${esc(r.locker_number || '-')}</div>
                        <p style="font-size:14px;opacity:0.8;margin-top:8px">Code d'acc√®s</p>
                        <div class="locker-code">${esc(r.locker_code || '-')}</div>
                    </div>
                    `).join('')}

                    <div class="info-box" style="text-align:left">
                        <h4 style="margin-bottom:8px"><i class="fas fa-receipt"></i> R√©capitulatif</h4>
                        <table class="summary-table">
                            <tr><td>R√©servation</td><td>${reservations.map(r => esc(r.reservation_number)).join(', ')}</td></tr>
                            <tr><td>Client</td><td>${esc((primary.guest_first_name || '') + ' ' + (primary.guest_last_name || ''))}</td></tr>
                            <tr><td>H√©bergement (${nbRooms} chambres)</td><td>${fmtPrice(primary.accommodation_price)}</td></tr>
                            <tr><td>Taxe de s√©jour (${primary.nb_adults} pers.)</td><td>${fmtPrice(primary.tourist_tax_amount)}</td></tr>
                            ${primary.breakfast_included ? `<tr><td>Petit-d√©jeuner <i class="fas fa-check-circle" style="color:var(--success)"></i></td><td>${fmtPrice(primary.breakfast_price)}</td></tr>` : ''}
                            <tr class="total"><td>Total pay√©</td><td>${fmtPrice(primary.total_amount)}</td></tr>
                        </table>
                        <p style="font-size:12px;color:var(--gray-500);margin-top:8px">${esc(primary.hotel_name)} - ${esc(primary.hotel_address || '')}, ${esc(primary.hotel_city || '')}</p>
                    </div>

                    ${primary.guest_email ? `
                    <div class="info-box success">
                        <p><i class="fas fa-envelope"></i> Une confirmation a √©t√© envoy√©e √† <strong>${esc(primary.guest_email)}</strong></p>
                    </div>` : ''}

                    <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="downloadReceipt()">
                            <i class="fas fa-file-pdf"></i> T√©l√©charger le re√ßu
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimer
                        </button>
                    </div>

                    <div style="margin-top:32px;padding-top:24px;border-top:1px solid var(--gray-200)">
                        <p style="font-size:24px">Bon s√©jour ! &#127969;</p>
                    </div>
                </div>
            </div>
        `;

        window._confirmationData = primary;
        window._allConfirmationData = reservations;
    }

    // ==================== PDF RECEIPT ====================

    function downloadReceipt() {
        const r = window._confirmationData;
        if (!r) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('RECU DE PAIEMENT', 105, 25, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(r.hotel_name || '', 105, 35, { align: 'center' });
        doc.setFontSize(10);
        doc.text((r.hotel_address || '') + ', ' + (r.hotel_city || ''), 105, 42, { align: 'center' });

        doc.setLineWidth(0.5);
        doc.line(20, 48, 190, 48);

        let y = 58;
        const addLine = (label, value) => {
            doc.setFont('helvetica', 'normal');
            doc.text(label, 25, y);
            doc.setFont('helvetica', 'bold');
            doc.text(String(value), 185, y, { align: 'right' });
            y += 8;
        };

        doc.setFontSize(11);
        addLine('Reservation :', r.reservation_number || '');
        addLine('Client :', (r.guest_first_name || '') + ' ' + (r.guest_last_name || ''));
        addLine("Date d'arrivee :", r.checkin_date || '');
        addLine('Chambre :', r.room_number || '');
        addLine('Casier :', (r.locker_number || '') + ' (Code: ' + (r.locker_code || '') + ')');

        y += 5;
        doc.line(20, y, 190, y);
        y += 10;

        doc.setFontSize(11);
        addLine('Hebergement :', fmtPrice(r.accommodation_price));
        addLine('Taxe de sejour (' + (r.nb_adults || 1) + ' pers.) :', fmtPrice(r.tourist_tax_amount));
        if (r.breakfast_included) {
            addLine('Petit-dejeuner :', fmtPrice(r.breakfast_price));
        }

        y += 3;
        doc.line(20, y, 190, y);
        y += 8;

        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.text('TOTAL :', 25, y);
        doc.text(fmtPrice(r.total_amount), 185, y, { align: 'right' });
        y += 8;

        if (r.deposit_amount > 0) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Arrhes versees :', 25, y);
            doc.text('- ' + fmtPrice(r.deposit_amount), 185, y, { align: 'right' });
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.text('Paye ce jour :', 25, y);
            doc.text(fmtPrice(r.remaining_amount), 185, y, { align: 'right' });
            y += 8;
        }

        y += 10;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('Date : ' + new Date().toLocaleDateString('fr-FR') + ' ' + new Date().toLocaleTimeString('fr-FR'), 25, y);
        y += 6;
        doc.text('Paiement par carte bancaire (Stripe)', 25, y);
        y += 12;
        doc.text('Merci et bon sejour !', 105, y, { align: 'center' });

        doc.save(`recu-${r.reservation_number || 'checkin'}.pdf`);
    }

    // ==================== START ====================
    init();
    </script>
</body>
</html>
