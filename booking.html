<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Check-in</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #DBEAFE;
            --success: #059669;
            --success-light: #ECFDF5;
            --danger: #DC2626;
            --warning: #D97706;
            --warning-light: #FFFBEB;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1e3a5f 0%, #2563EB 100%); color: var(--gray-800); min-height: 100vh; display: flex; flex-direction: column; }

        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--gray-200); padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
        .header img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header .stars { color: #F59E0B; font-size: 12px; margin-left: 8px; }

        .main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 24px; }
        .card { background: white; border-radius: 16px; box-shadow: var(--shadow-lg); max-width: 600px; width: 100%; overflow: hidden; }
        .card-wide { max-width: 700px; }
        .card-body { padding: 32px; }
        .card-header { padding: 24px 32px; border-bottom: 1px solid var(--gray-100); }
        .card-header h2 { font-size: 20px; font-weight: 600; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 10px; font-size: 15px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
        .btn-outline { background: white; border: 2px solid var(--gray-200); color: var(--gray-700); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-lg { padding: 16px 32px; font-size: 17px; border-radius: 12px; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200); border-radius: 8px; font-size: 15px; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .choice-grid { display: grid; gap: 16px; margin-top: 24px; }
        .choice-card { padding: 24px; border: 2px solid var(--gray-200); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .choice-card:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow); }
        .choice-card.selected { border-color: var(--primary); background: var(--primary-light); }
        .choice-card i { font-size: 36px; color: var(--primary); display: block; margin-bottom: 12px; }
        .choice-card h3 { font-size: 16px; margin-bottom: 4px; }
        .choice-card p { font-size: 13px; color: var(--gray-500); }

        .summary-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        .summary-table td { padding: 8px 0; font-size: 14px; border-bottom: 1px solid var(--gray-100); }
        .summary-table td:last-child { text-align: right; font-weight: 500; }
        .summary-table tr.total td { border-top: 2px solid var(--gray-800); border-bottom: none; font-size: 16px; font-weight: 700; padding-top: 12px; }
        .summary-table tr.deposit td { color: var(--success); }
        .summary-table tr.remaining td { color: var(--primary); font-size: 18px; font-weight: 700; }

        .info-box { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px; margin: 16px 0; }
        .info-box.success { background: var(--success-light); border-color: #A7F3D0; }
        .info-box.warning { background: var(--warning-light); border-color: #FDE68A; }

        .locker-display { text-align: center; padding: 32px; background: linear-gradient(135deg, #1e3a5f, #2563EB); border-radius: 12px; color: white; margin: 20px 0; }
        .locker-display .locker-number { font-size: 48px; font-weight: 800; margin: 8px 0; }
        .locker-display .locker-code { font-size: 28px; font-weight: 700; letter-spacing: 4px; background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 8px; display: inline-block; margin: 8px 0; }
        .locker-display .room-info { margin-top: 12px; font-size: 18px; }

        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--gray-300); transition: all 0.3s; }
        .step-dot.active { background: var(--primary); width: 28px; border-radius: 5px; }
        .step-dot.done { background: var(--success); }

        .alert { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin: 12px 0; }
        .alert-error { background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA; }
        .alert-info { background: #EFF6FF; color: var(--primary); border: 1px solid #BFDBFE; }

        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .id-upload-zone { border: 2px dashed var(--gray-300); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .id-upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }
        .id-upload-zone i { font-size: 36px; color: var(--gray-400); margin-bottom: 12px; }
        .id-upload-zone.has-file { border-color: var(--success); background: var(--success-light); }
        .id-upload-zone.has-file i { color: var(--success); }

        #stripe-element { padding: 14px; border: 1.5px solid var(--gray-200); border-radius: 8px; background: white; }

        .back-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; }
        .back-link:hover { color: white; }

        .service-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .service-item:hover { border-color: var(--primary); background: var(--primary-light); }
        .service-item.selected { border-color: var(--primary); background: var(--primary-light); }
        .service-item .service-info { display: flex; align-items: center; gap: 10px; }
        .service-item .service-price { font-weight: 700; color: var(--primary); white-space: nowrap; }

        .rgpd-notice { background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 12px 14px; font-size: 12px; color: #0369A1; margin: 12px 0; }
        .rgpd-notice i { margin-right: 6px; }

        .editable-field { display: flex; align-items: center; gap: 8px; }
        .editable-field input, .editable-field select { flex: 1; }

        @media (max-width: 640px) {
            .card-body { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .locker-display .locker-number { font-size: 36px; }
            .choice-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header" id="hotel-header" style="display:none">
        <img id="hotel-logo" src="" alt="" onerror="this.style.display='none'">
        <div>
            <h1 id="hotel-name"></h1>
            <span id="hotel-stars"></span>
        </div>
    </div>

    <div class="main">
        <div id="app">
            <div style="text-align:center;color:white">
                <div class="spinner" style="width:40px;height:40px;border-width:4px;margin:0 auto 16px"></div>
                <p>Chargement...</p>
            </div>
        </div>
    </div>

    <script>
    // ==================== CONFIG & STATE ====================
    const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? 'http://localhost:8000/api' : window.location.origin + '/api';

    let hotelSlug = new URLSearchParams(window.location.search).get('hotel');
    let hotel = null;
    let pricing = null;
    let stripe = null;
    let stripeElements = null;
    let cardElement = null;
    let currentReservation = null;
    let currentStep = 'welcome';
    let idDocumentPath = null;
    let availableServices = [];
    let selectedServices = {};
    let walkinNbAdults = 1;
    let walkinAvailableRooms = [];
    let lastLookupData = null;

    // ==================== API ====================
    async function apiGet(url) {
        const r = await fetch(API_BASE + url);
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Erreur serveur');
        return data;
    }

    async function apiPost(url, body) {
        const r = await fetch(API_BASE + url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Erreur serveur');
        return data;
    }

    async function apiUpload(url, file) {
        const formData = new FormData();
        formData.append('id_document', file);
        const r = await fetch(API_BASE + url, { method: 'POST', body: formData });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Erreur upload');
        return data;
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
    function fmtPrice(n) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0); }
    function fmtDate(d) { if (!d) return '-'; return new Date(d + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); }

    const ROOM_TYPE_LABELS = {
        standard: 'Standard', superieure: 'Supérieure', suite: 'Suite',
        triple: 'Triple', quadruple: 'Quadruple',
        familiale: 'Familiale', pmr: 'PMR'
    };
    const BED_TYPE_LABELS = {
        single: 'Simple', double: 'Double', twin: 'Twin (2 lits)',
        queen: 'Queen', king: 'King'
    };

    // ==================== INIT ====================
    async function init() {
        if (!hotelSlug) {
            showError('Aucun hôtel spécifié. Vérifiez le lien.');
            return;
        }

        try {
            const res = await apiGet(`/booking/${hotelSlug}`);
            hotel = res.hotel;
            pricing = res.pricing;

            // Init Stripe
            if (hotel.stripe_public_key) {
                stripe = Stripe(hotel.stripe_public_key);
            }

            // Load available services
            try {
                const svcRes = await apiGet(`/booking/${hotelSlug}/services`);
                availableServices = svcRes.services || [];
            } catch (e) { availableServices = []; }

            // Update header
            document.getElementById('hotel-header').style.display = 'flex';
            document.getElementById('hotel-name').textContent = hotel.name;
            if (hotel.logo_url) document.getElementById('hotel-logo').src = hotel.logo_url;
            if (hotel.stars) {
                document.getElementById('hotel-stars').innerHTML = Array(parseInt(hotel.stars)).fill('<i class="fas fa-star" style="color:#F59E0B;font-size:12px"></i>').join('');
            }
            document.title = `Self Check-in - ${hotel.name}`;

            showWelcome();
        } catch (err) {
            showError(err.message);
        }
    }

    // ==================== VIEWS ====================

    function showError(msg) {
        document.getElementById('app').innerHTML = `
            <div class="card">
                <div class="card-body" style="text-align:center;padding:48px">
                    <i class="fas fa-exclamation-triangle" style="font-size:48px;color:var(--warning);margin-bottom:16px"></i>
                    <h2 style="margin-bottom:8px">Erreur</h2>
                    <p style="color:var(--gray-500)">${esc(msg)}</p>
                </div>
            </div>
        `;
    }

    function showWelcome() {
        currentStep = 'welcome';
        document.getElementById('app').innerHTML = `
            <div class="card card-wide">
                <div class="card-body" style="text-align:center;padding:40px">
                    <i class="fas fa-door-open" style="font-size:48px;color:var(--primary);margin-bottom:16px"></i>
                    <h2 style="margin-bottom:8px">Bienvenue !</h2>
                    <p style="color:var(--gray-500);margin-bottom:32px">Self check-in ${esc(hotel.name)}</p>

                    <div class="choice-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="choice-card" onclick="showLookup()">
                            <i class="fas fa-search"></i>
                            <h3>J'ai une réservation</h3>
                            <p>Rechercher ma réservation et récupérer ma clé</p>
                        </div>
                        ${hotel.walkin_enabled ? `
                        <div class="choice-card" onclick="showWalkinPersonCount()">
                            <i class="fas fa-walking"></i>
                            <h3>Sans réservation</h3>
                            <p>Réserver une chambre disponible maintenant</p>
                        </div>` : `
                        <div class="choice-card" style="opacity:0.4;cursor:default">
                            <i class="fas fa-walking"></i>
                            <h3>Sans réservation</h3>
                            <p>Non disponible actuellement</p>
                        </div>`}
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== FLOW A: WITH RESERVATION ====================

    function showLookup() {
        currentStep = 'lookup';
        document.getElementById('app').innerHTML = `
            <a href="javascript:showWelcome()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-search"></i> Rechercher votre réservation</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <form onsubmit="doLookup(event)">
                        <div class="form-group">
                            <label>Numéro de réservation</label>
                            <input type="text" id="lookup-number" placeholder="Ex: SC-A1B2C3-260211">
                        </div>
                        <p style="text-align:center;color:var(--gray-400);margin:12px 0">ou</p>
                        <div class="form-group">
                            <label>Nom de famille</label>
                            <input type="text" id="lookup-name" placeholder="Votre nom de famille">
                        </div>
                        <div id="lookup-error"></div>
                        <button type="submit" class="btn btn-primary btn-block btn-lg" id="lookup-btn">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    async function doLookup(e) {
        e.preventDefault();
        const number = document.getElementById('lookup-number').value.trim();
        const name = document.getElementById('lookup-name').value.trim();
        const errDiv = document.getElementById('lookup-error');
        const btn = document.getElementById('lookup-btn');

        if (!number && !name) {
            errDiv.innerHTML = '<div class="alert alert-error">Veuillez saisir un numéro de réservation ou votre nom.</div>';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Recherche...';
        errDiv.innerHTML = '';

        try {
            const body = {};
            if (number) body.reservation_number = number;
            else body.last_name = name;

            const res = await apiPost(`/booking/${hotelSlug}/lookup`, body);
            currentReservation = res.reservation;
            lastLookupData = res;
            showReservationDetails(res);
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-times-circle"></i> ${esc(err.message)}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i> Rechercher';
        }
    }

    function showReservationDetails(data) {
        currentStep = 'details';
        const r = data.reservation;
        const bfOption = data.breakfast_option;
        const canAddBreakfast = !r.breakfast_included && bfOption && bfOption.unit_price > 0;
        const nbPersons = r.nb_adults + r.nb_children;
        const maxAdults = r.room_max_adults || 10;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showLookup()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-clipboard-check"></i> Votre réservation</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                    </div>

                    <div class="info-box">
                        <p><strong>N° ${esc(r.reservation_number)}</strong></p>
                        <p style="margin-top:8px;font-size:13px;color:var(--gray-500)">
                            Arrivée : ${fmtDate(r.checkin_date)}
                            ${r.room_number ? ' | Chambre ' + esc(r.room_number) : ''}
                            ${maxAdults ? ' (max ' + maxAdults + ' adulte(s))' : ''}
                        </p>
                    </div>

                    <h3 style="margin:20px 0 12px"><i class="fas fa-user-edit"></i> Vos informations <small style="font-weight:400;color:var(--gray-400)">(modifiable)</small></h3>
                    <form id="reservation-edit-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prénom</label>
                                <input type="text" id="res-firstname" value="${esc(r.guest_first_name || '')}">
                            </div>
                            <div class="form-group">
                                <label>Nom</label>
                                <input type="text" id="res-lastname" value="${esc(r.guest_last_name || '')}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="res-email" value="${esc(r.guest_email || '')}">
                            </div>
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" id="res-phone" value="${esc(r.guest_phone || '')}" placeholder="+33 6 ...">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre d'adultes</label>
                                <select id="res-adults" onchange="onResAdultsChange()">
                                    ${[1,2,3,4,5,6].map(n => `<option value="${n}" ${r.nb_adults === n ? 'selected' : ''} ${n > maxAdults ? 'disabled' : ''}>${n}${n > maxAdults ? ' (hors capacité)' : ''}</option>`).join('')}
                                </select>
                                ${maxAdults ? `<small style="color:var(--gray-500)">Capacité max de la chambre : ${maxAdults} adulte(s)</small>` : ''}
                            </div>
                            <div class="form-group">
                                <label>Nombre d'enfants</label>
                                <select id="res-children">
                                    ${[0,1,2,3,4].map(n => `<option value="${n}" ${r.nb_children === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div id="res-capacity-warning"></div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="saveReservationEdits()" id="save-edits-btn" style="margin-bottom:16px">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                        <div id="res-edit-status"></div>
                    </form>

                    <h3 style="margin:20px 0 12px"><i class="fas fa-receipt"></i> Détail de la réservation</h3>
                    <table class="summary-table">
                        <tr><td>Hébergement</td><td>${fmtPrice(r.accommodation_price)}</td></tr>
                        <tr><td>Taxe de séjour</td><td>${fmtPrice(r.tourist_tax_amount)}</td></tr>
                        <tr><td>Petit-déjeuner ${r.breakfast_included ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : '<span style="color:var(--gray-400)">(non inclus)</span>'}</td><td>${r.breakfast_included ? fmtPrice(r.breakfast_price) : '-'}</td></tr>
                        <tr class="total"><td>Total</td><td>${fmtPrice(r.total_amount)}</td></tr>
                        ${r.deposit_amount > 0 ? `<tr class="deposit"><td>Arrhes versées</td><td>- ${fmtPrice(r.deposit_amount)}</td></tr>` : ''}
                        <tr class="remaining"><td>Reste à payer</td><td>${fmtPrice(r.remaining_amount)}</td></tr>
                    </table>

                    ${canAddBreakfast ? `
                    <div class="info-box" id="breakfast-option">
                        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
                            <div>
                                <p style="font-weight:600"><i class="fas fa-coffee"></i> Ajouter le petit-déjeuner ?</p>
                                <p style="font-size:13px;color:var(--gray-500)">${fmtPrice(bfOption.unit_price)} / personne (${nbPersons} pers.) | ${bfOption.start} - ${bfOption.end}</p>
                                <p style="font-size:14px;font-weight:600;color:var(--primary)">+ ${fmtPrice(bfOption.unit_price * nbPersons)}</p>
                            </div>
                            <button class="btn btn-outline" onclick="addBreakfast(${r.id})" id="add-breakfast-btn">
                                <i class="fas fa-plus"></i> Ajouter
                            </button>
                        </div>
                    </div>` : ''}

                    <div style="margin-top:24px">
                        ${r.remaining_amount > 0 ? `
                        <button class="btn btn-primary btn-block btn-lg" onclick="showPayment()">
                            <i class="fas fa-credit-card"></i> Payer ${fmtPrice(r.remaining_amount)}
                        </button>` : `
                        <button class="btn btn-success btn-block btn-lg" onclick="confirmNoPayment()">
                            <i class="fas fa-check"></i> Confirmer mon arrivée
                        </button>`}
                    </div>
                </div>
            </div>
        `;
    }

    function onResAdultsChange() {
        const maxAdults = currentReservation.room_max_adults || 10;
        const selected = parseInt(document.getElementById('res-adults').value);
        const warnDiv = document.getElementById('res-capacity-warning');
        if (selected > maxAdults) {
            warnDiv.innerHTML = `<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> La chambre ne peut accueillir que ${maxAdults} adulte(s) maximum.</div>`;
        } else {
            warnDiv.innerHTML = '';
        }
    }

    async function saveReservationEdits() {
        const btn = document.getElementById('save-edits-btn');
        const statusDiv = document.getElementById('res-edit-status');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="border-color:var(--gray-300);border-top-color:var(--primary)"></span> Enregistrement...';

        try {
            const updateData = {
                reservation_id: currentReservation.id,
                guest_first_name: document.getElementById('res-firstname').value.trim(),
                guest_last_name: document.getElementById('res-lastname').value.trim(),
                guest_email: document.getElementById('res-email').value.trim(),
                guest_phone: document.getElementById('res-phone').value.trim(),
                nb_adults: parseInt(document.getElementById('res-adults').value),
                nb_children: parseInt(document.getElementById('res-children').value)
            };

            const res = await apiPost(`/booking/${hotelSlug}/update-reservation`, updateData);
            currentReservation = { ...currentReservation, ...res.reservation };

            // Re-fetch full data
            const lookupRes = await apiPost(`/booking/${hotelSlug}/lookup`, {
                reservation_number: currentReservation.reservation_number
            });
            currentReservation = lookupRes.reservation;
            lastLookupData = lookupRes;
            showReservationDetails(lookupRes);

            statusDiv.innerHTML = '<div class="alert alert-info" style="margin-top:8px"><i class="fas fa-check-circle"></i> Modifications enregistrées</div>';
            setTimeout(() => { const s = document.getElementById('res-edit-status'); if (s) s.innerHTML = ''; }, 3000);
        } catch (err) {
            statusDiv.innerHTML = `<div class="alert alert-error" style="margin-top:8px">${esc(err.message)}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        }
    }

    async function addBreakfast(reservationId) {
        const btn = document.getElementById('add-breakfast-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';

        try {
            const res = await apiPost(`/booking/${hotelSlug}/update-reservation`, {
                reservation_id: reservationId,
                add_breakfast: true
            });
            currentReservation = { ...currentReservation, ...res.reservation };

            const lookupRes = await apiPost(`/booking/${hotelSlug}/lookup`, {
                reservation_number: currentReservation.reservation_number
            });
            currentReservation = lookupRes.reservation;
            lastLookupData = lookupRes;
            showReservationDetails(lookupRes);
        } catch (err) {
            alert('Erreur: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus"></i> Ajouter';
        }
    }

    async function confirmNoPayment() {
        try {
            const res = await apiPost(`/booking/${hotelSlug}/pay`, {
                reservation_id: currentReservation.id
            });
            if (res.no_payment_needed) {
                showConfirmation(res.reservation);
            }
        } catch (err) {
            alert('Erreur: ' + err.message);
        }
    }

    // ==================== PAYMENT ====================

    async function showPayment() {
        currentStep = 'payment';

        document.getElementById('app').innerHTML = `
            <a href="javascript:showReservationDetails(lastLookupData)" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-credit-card"></i> Paiement</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                    </div>

                    <div class="info-box">
                        <p style="font-size:13px;color:var(--gray-500)">Réservation ${esc(currentReservation.reservation_number)}</p>
                        <p style="font-size:24px;font-weight:700;color:var(--primary);margin-top:4px">${fmtPrice(currentReservation.remaining_amount)}</p>
                    </div>

                    <div id="payment-error"></div>

                    <div class="form-group">
                        <label>Carte bancaire</label>
                        <div id="stripe-element"></div>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" id="pay-btn" onclick="processPayment()" disabled>
                        <i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}
                    </button>

                    <p style="text-align:center;font-size:12px;color:var(--gray-400);margin-top:12px">
                        <i class="fas fa-shield-alt"></i> Paiement sécurisé par Stripe
                    </p>
                </div>
            </div>
        `;

        try {
            const res = await apiPost(`/booking/${hotelSlug}/pay`, {
                reservation_id: currentReservation.id
            });

            if (res.no_payment_needed) {
                showConfirmation(res.reservation);
                return;
            }

            window._paymentIntentId = res.payment_intent_id;
            window._clientSecret = res.client_secret;

            stripeElements = stripe.elements({ clientSecret: res.client_secret });
            cardElement = stripeElements.create('payment');
            cardElement.mount('#stripe-element');
            cardElement.on('change', (e) => {
                document.getElementById('pay-btn').disabled = !e.complete;
            });
        } catch (err) {
            document.getElementById('payment-error').innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
        }
    }

    async function processPayment() {
        const btn = document.getElementById('pay-btn');
        const errDiv = document.getElementById('payment-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement en cours...';
        errDiv.innerHTML = '';

        try {
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements: stripeElements,
                confirmParams: { return_url: window.location.href },
                redirect: 'if_required'
            });

            if (error) {
                errDiv.innerHTML = `<div class="alert alert-error">${esc(error.message)}</div>`;
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
                return;
            }

            if (paymentIntent.status === 'succeeded') {
                const confirmRes = await apiPost(`/booking/${hotelSlug}/confirm`, {
                    reservation_id: currentReservation.id,
                    payment_intent_id: paymentIntent.id
                });
                showConfirmation(confirmRes.reservation);
            }
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
        }
    }

    // ==================== FLOW B: WALK-IN ====================

    // Step 1: Ask number of persons FIRST
    function showWalkinPersonCount() {
        currentStep = 'walkin-persons';
        selectedServices = {};
        idDocumentPath = null;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWelcome()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-users"></i> Nombre de personnes</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <p style="color:var(--gray-500);margin-bottom:20px">Combien de personnes séjourneront ?</p>

                    <div class="form-group">
                        <label>Nombre d'adultes *</label>
                        <select id="walkin-nb-adults" style="font-size:18px;padding:14px">
                            ${[1,2,3,4,5,6].map(n => `<option value="${n}">${n} adulte${n > 1 ? 's' : ''}</option>`).join('')}
                        </select>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" onclick="searchWalkinRooms()">
                        <i class="fas fa-search"></i> Rechercher les chambres disponibles
                    </button>
                </div>
            </div>
        `;
    }

    // Step 2: Search and show available rooms (no room number shown)
    async function searchWalkinRooms() {
        walkinNbAdults = parseInt(document.getElementById('walkin-nb-adults').value) || 1;
        currentStep = 'walkin-rooms';

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-bed"></i> Chambres disponibles</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>
                    <div style="text-align:center;padding:20px">
                        <div class="spinner" style="width:30px;height:30px;border-color:var(--gray-300);border-top-color:var(--primary)"></div>
                        <p style="margin-top:8px;color:var(--gray-500)">Recherche des chambres pour ${walkinNbAdults} adulte(s)...</p>
                    </div>
                </div>
            </div>
        `;

        try {
            const res = await apiGet(`/booking/${hotelSlug}/available-rooms?nb_adults=${walkinNbAdults}`);
            if (!res.rooms || res.rooms.length === 0) {
                document.getElementById('app').innerHTML = `
                    <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
                    <div class="card">
                        <div class="card-body" style="text-align:center;padding:48px">
                            <i class="fas fa-bed" style="font-size:48px;color:var(--gray-300);margin-bottom:16px"></i>
                            <h2>Aucune chambre disponible</h2>
                            <p style="color:var(--gray-500);margin-top:8px">Désolé, il n'y a pas de chambre disponible pour ${walkinNbAdults} adulte(s) cette nuit.</p>
                            <button class="btn btn-outline" style="margin-top:20px" onclick="showWalkinPersonCount()">Modifier le nombre de personnes</button>
                        </div>
                    </div>
                `;
                return;
            }

            pricing = res.pricing;
            walkinAvailableRooms = res.rooms;
            showWalkinRoomSelection(res.rooms, res.pricing);
        } catch (err) {
            showError(err.message);
        }
    }

    function showWalkinRoomSelection(rooms, pricingData) {
        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinPersonCount()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-bed"></i> Choisissez votre chambre</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <div class="info-box">
                        <p><strong>Tarif de la nuit :</strong> ${fmtPrice(pricingData.night_price)}</p>
                        <p style="font-size:13px;color:var(--gray-500);margin-top:4px">
                            Taxe de séjour : ${fmtPrice(pricingData.tourist_tax)} / adulte |
                            Petit-déjeuner : ${fmtPrice(pricingData.breakfast_price)} / pers (${pricingData.breakfast_start} - ${pricingData.breakfast_end})
                        </p>
                        <p style="font-size:13px;color:var(--primary);margin-top:4px;font-weight:600">
                            <i class="fas fa-users"></i> ${walkinNbAdults} adulte(s)
                        </p>
                    </div>

                    <div class="choice-grid" style="margin-top:16px">
                        ${rooms.map(r => `
                            <div class="choice-card" onclick="selectWalkinRoom(${r.id})">
                                <i class="fas fa-bed"></i>
                                <h3>${esc(ROOM_TYPE_LABELS[r.room_type] || r.room_type)}</h3>
                                <p>${esc(BED_TYPE_LABELS[r.bed_type] || r.bed_type)} - Max ${r.max_adults} adulte(s)</p>
                                <p style="font-weight:600;color:var(--primary);margin-top:4px">${fmtPrice(pricingData.night_price)} / nuit</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    function selectWalkinRoom(reservationId) {
        currentReservation = { id: reservationId };
        showWalkinIdUpload();
    }

    // Step 3: ID Upload with RGPD notice
    function showWalkinIdUpload() {
        currentStep = 'walkin-id';
        document.getElementById('app').innerHTML = `
            <a href="javascript:searchWalkinRooms()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-id-card"></i> Pièce d'identité</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                        <div class="step-dot"></div>
                    </div>

                    <p style="color:var(--gray-500);margin-bottom:12px">Pour des raisons légales, veuillez photographier votre pièce d'identité.</p>

                    <div class="rgpd-notice">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Protection de vos données (RGPD)</strong><br>
                        Conformément au Règlement Général sur la Protection des Données, votre pièce d'identité est collectée uniquement pour vérifier votre identité lors du check-in.
                        Elle sera conservée de manière sécurisée et <strong>automatiquement supprimée après 7 jours</strong>.
                        Aucune copie ne sera conservée au-delà de ce délai. Vous pouvez exercer vos droits d'accès, de rectification et de suppression en contactant l'établissement.
                    </div>

                    <div class="id-upload-zone" id="id-upload-zone" onclick="document.getElementById('id-file-input').click()">
                        <i class="fas fa-camera"></i>
                        <p style="font-weight:600">Prendre une photo ou importer un fichier</p>
                        <p style="font-size:12px;color:var(--gray-400);margin-top:4px">JPG, PNG ou WebP - Max 20 Mo</p>
                    </div>
                    <input type="file" id="id-file-input" accept="image/*" capture="environment" style="display:none" onchange="handleIdUpload(this)">

                    <div id="id-preview" style="display:none;margin-top:16px;text-align:center">
                        <img id="id-preview-img" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid var(--gray-200)">
                    </div>

                    <div id="id-upload-status" style="margin-top:12px"></div>
                    <div id="id-quality-option" style="display:none"></div>

                    <div class="form-group" style="margin-top:16px">
                        <label>Date de naissance (vérification majorité) *</label>
                        <input type="date" id="walkin-birthdate" required max="${new Date().toISOString().split('T')[0]}">
                        <small style="color:var(--gray-500)">Vous devez avoir au moins 18 ans</small>
                    </div>

                    <div id="id-error"></div>

                    <button class="btn btn-primary btn-block btn-lg" id="id-continue-btn" onclick="validateIdAndContinue()" disabled>
                        <i class="fas fa-arrow-right"></i> Continuer
                    </button>
                </div>
            </div>
        `;
    }

    async function handleIdUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const maxSize = 20 * 1024 * 1024; // 20 Mo

        // Check file size and propose quality reduction
        if (file.size > maxSize) {
            const qualityDiv = document.getElementById('id-quality-option');
            qualityDiv.style.display = 'block';
            qualityDiv.innerHTML = `
                <div class="info-box warning">
                    <p style="font-weight:600"><i class="fas fa-exclamation-triangle"></i> Fichier trop volumineux (${(file.size / 1024 / 1024).toFixed(1)} Mo)</p>
                    <p style="font-size:13px;color:var(--gray-500);margin:8px 0">La taille maximale est de 20 Mo. Souhaitez-vous réduire la qualité de l'image ?</p>
                    <button class="btn btn-primary btn-sm" onclick="compressAndUpload()">
                        <i class="fas fa-compress"></i> Réduire la qualité et envoyer
                    </button>
                </div>
            `;
            window._originalFile = file;
            return;
        }

        await doUploadId(file);
    }

    async function compressAndUpload() {
        const file = window._originalFile;
        if (!file) return;

        const qualityDiv = document.getElementById('id-quality-option');
        qualityDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Compression en cours...</div>';

        try {
            const compressed = await compressImage(file, 0.5, 1600);
            await doUploadId(compressed);
            qualityDiv.style.display = 'none';
        } catch (err) {
            qualityDiv.innerHTML = `<div class="alert alert-error">Erreur de compression : ${esc(err.message)}. Essayez avec une image plus petite.</div>`;
        }
    }

    function compressImage(file, quality, maxDim) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob((blob) => {
                        if (!blob) { reject(new Error('Compression failed')); return; }
                        const compressed = new File([blob], file.name.replace(/\.\w+$/, '.jpg'), { type: 'image/jpeg' });
                        resolve(compressed);
                    }, 'image/jpeg', quality);
                };
                img.onerror = () => reject(new Error('Image invalide'));
                img.src = e.target.result;
            };
            reader.onerror = () => reject(new Error('Erreur lecture'));
            reader.readAsDataURL(file);
        });
    }

    async function doUploadId(file) {
        // Preview
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('id-preview-img').src = e.target.result;
            document.getElementById('id-preview').style.display = 'block';
            document.getElementById('id-upload-zone').classList.add('has-file');
            document.getElementById('id-upload-zone').innerHTML = '<i class="fas fa-check-circle"></i><p style="font-weight:600;color:var(--success)">Photo ajoutée</p>';
        };
        reader.readAsDataURL(file);

        // Upload to server
        const statusDiv = document.getElementById('id-upload-status');
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Upload en cours...</div>';

        try {
            const res = await apiUpload(`/booking/${hotelSlug}/upload-id`, file);
            idDocumentPath = res.path;
            statusDiv.innerHTML = `<div class="alert alert-info"><i class="fas fa-check-circle"></i> Document enregistré</div>`;
            document.getElementById('id-continue-btn').disabled = false;
        } catch (err) {
            statusDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            // If file too large, suggest compression
            if (err.message.includes('volumineux') || err.message.includes('trop')) {
                const qualityDiv = document.getElementById('id-quality-option');
                qualityDiv.style.display = 'block';
                window._originalFile = file;
                qualityDiv.innerHTML = `
                    <div class="info-box warning" style="margin-top:8px">
                        <p style="font-weight:600"><i class="fas fa-compress"></i> Réduire la qualité ?</p>
                        <p style="font-size:13px;margin:4px 0">Le fichier est trop volumineux. Nous pouvons réduire automatiquement la qualité.</p>
                        <button class="btn btn-primary btn-sm" onclick="compressAndUpload()" style="margin-top:8px">
                            <i class="fas fa-compress"></i> Réduire et réessayer
                        </button>
                    </div>
                `;
            }
        }
    }

    function validateIdAndContinue() {
        const birthdate = document.getElementById('walkin-birthdate').value;
        const errDiv = document.getElementById('id-error');

        if (!birthdate) {
            errDiv.innerHTML = '<div class="alert alert-error">Veuillez saisir votre date de naissance.</div>';
            return;
        }

        const birth = new Date(birthdate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;

        if (age < 18) {
            errDiv.innerHTML = '<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> Vous devez avoir au moins 18 ans pour effectuer un check-in.</div>';
            return;
        }

        if (!idDocumentPath) {
            errDiv.innerHTML = '<div class="alert alert-error">Veuillez d\'abord photographier votre pièce d\'identité.</div>';
            return;
        }

        showWalkinForm();
    }

    // Step 4: Guest info + services + recap
    function showWalkinForm() {
        currentStep = 'walkin-form';
        const p = pricing;

        // Build max adults options based on selected room capacity
        const selectedRoom = walkinAvailableRooms.find(r => r.id === currentReservation.id);
        const maxAdults = selectedRoom ? selectedRoom.max_adults : 6;

        document.getElementById('app').innerHTML = `
            <a href="javascript:showWalkinIdUpload()" class="back-link"><i class="fas fa-arrow-left"></i> Retour</a>
            <div class="card card-wide">
                <div class="card-header">
                    <h2><i class="fas fa-user"></i> Vos informations</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                        <div class="step-dot"></div>
                    </div>

                    <form onsubmit="submitWalkin(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prénom *</label>
                                <input type="text" id="wi-firstname" required>
                            </div>
                            <div class="form-group">
                                <label>Nom *</label>
                                <input type="text" id="wi-lastname" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" id="wi-email" required>
                            </div>
                            <div class="form-group">
                                <label>Téléphone *</label>
                                <input type="tel" id="wi-phone" required placeholder="+33 6 ...">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre d'adultes *</label>
                                <select id="wi-adults" onchange="updateWalkinPricing()">
                                    ${Array.from({length: maxAdults}, (_, i) => i + 1).map(n => `<option value="${n}" ${n === walkinNbAdults ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                                <small style="color:var(--gray-500)">Max ${maxAdults} adulte(s) pour cette chambre</small>
                            </div>
                            <div class="form-group">
                                <label>Nombre d'enfants</label>
                                <select id="wi-children" onchange="updateWalkinPricing()">
                                    ${[0,1,2,3,4].map(n => `<option value="${n}">${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="wi-breakfast" onchange="updateWalkinPricing()">
                                Petit-déjeuner (${fmtPrice(p.breakfast_price)} / pers) - ${p.breakfast_start} à ${p.breakfast_end}
                            </label>
                        </div>

                        ${availableServices.length > 0 ? `
                        <h3 style="margin:20px 0 12px"><i class="fas fa-concierge-bell"></i> Services complémentaires</h3>
                        <div id="services-list">
                            ${availableServices.map(s => `
                                <div class="service-item" id="svc-${s.id}" onclick="toggleService(${s.id}, '${esc(s.name)}', ${s.price})">
                                    <div class="service-info">
                                        <i class="fas fa-${esc(s.icon || 'concierge-bell')}" style="color:var(--primary);font-size:18px"></i>
                                        <div>
                                            <strong style="font-size:14px">${esc(s.name)}</strong>
                                            ${s.description ? `<br><small style="color:var(--gray-500)">${esc(s.description)}</small>` : ''}
                                        </div>
                                    </div>
                                    <div class="service-price">${fmtPrice(s.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}

                        <h3 style="margin:20px 0 12px"><i class="fas fa-receipt"></i> Récapitulatif</h3>
                        <div id="walkin-pricing-summary"></div>

                        <div id="walkin-error"></div>

                        <button type="submit" class="btn btn-primary btn-block btn-lg" id="walkin-submit-btn">
                            <i class="fas fa-credit-card"></i> Procéder au paiement
                        </button>
                    </form>
                </div>
            </div>
        `;

        updateWalkinPricing();
    }

    function toggleService(id, name, price) {
        if (selectedServices[id]) {
            delete selectedServices[id];
            document.getElementById('svc-' + id).classList.remove('selected');
        } else {
            selectedServices[id] = { id, name, price, quantity: 1 };
            document.getElementById('svc-' + id).classList.add('selected');
        }
        updateWalkinPricing();
    }

    function updateWalkinPricing() {
        const p = pricing;
        const nbAdults = parseInt(document.getElementById('wi-adults').value) || 1;
        const nbChildren = parseInt(document.getElementById('wi-children').value) || 0;
        const nbPersons = nbAdults + nbChildren;
        const wantsBreakfast = document.getElementById('wi-breakfast').checked;

        const accommodation = p.night_price;
        const touristTax = p.tourist_tax * nbAdults;
        const breakfast = wantsBreakfast ? p.breakfast_price * nbPersons : 0;

        let servicesTotal = 0;
        Object.values(selectedServices).forEach(s => { servicesTotal += s.price * s.quantity; });

        const total = accommodation + touristTax + breakfast + servicesTotal;

        document.getElementById('walkin-pricing-summary').innerHTML = `
            <table class="summary-table">
                <tr><td>Chambre - 1 nuit</td><td>${fmtPrice(accommodation)}</td></tr>
                <tr><td>Taxe de séjour (${nbAdults} adulte(s))</td><td>${fmtPrice(touristTax)}</td></tr>
                ${wantsBreakfast ? `<tr><td>Petit-déjeuner (${nbPersons} pers.)</td><td>${fmtPrice(breakfast)}</td></tr>` : ''}
                ${Object.values(selectedServices).map(s => `<tr><td><i class="fas fa-concierge-bell" style="color:var(--primary)"></i> ${esc(s.name)}</td><td>${fmtPrice(s.price)}</td></tr>`).join('')}
                <tr class="total"><td>Total à payer</td><td>${fmtPrice(total)}</td></tr>
            </table>
        `;
    }

    async function submitWalkin(e) {
        e.preventDefault();
        const btn = document.getElementById('walkin-submit-btn');
        const errDiv = document.getElementById('walkin-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement...';
        errDiv.innerHTML = '';

        try {
            const svcArray = Object.values(selectedServices).map(s => ({ id: s.id, quantity: s.quantity }));

            const res = await apiPost(`/booking/${hotelSlug}/walkin`, {
                reservation_id: currentReservation.id,
                guest_first_name: document.getElementById('wi-firstname').value.trim(),
                guest_last_name: document.getElementById('wi-lastname').value.trim(),
                guest_email: document.getElementById('wi-email').value.trim(),
                guest_phone: document.getElementById('wi-phone').value.trim(),
                nb_adults: parseInt(document.getElementById('wi-adults').value),
                nb_children: parseInt(document.getElementById('wi-children').value),
                breakfast: document.getElementById('wi-breakfast').checked ? 1 : 0,
                id_document_path: idDocumentPath,
                services: svcArray
            });

            currentReservation = {
                ...currentReservation,
                id: res.reservation_id,
                remaining_amount: res.amount,
                reservation_number: currentReservation.reservation_number || 'N/A'
            };
            window._paymentIntentId = res.payment_intent_id;
            window._clientSecret = res.client_secret;
            window._walkinPricingDetail = res.pricing_detail;

            showWalkinPayment(res);
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-credit-card"></i> Procéder au paiement';
        }
    }

    // Step 5: Payment (no room number shown yet)
    function showWalkinPayment(payData) {
        currentStep = 'walkin-payment';

        document.getElementById('app').innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-credit-card"></i> Paiement</h2>
                </div>
                <div class="card-body">
                    <div class="step-indicator">
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot done"></div>
                        <div class="step-dot active"></div>
                    </div>

                    <div class="info-box">
                        <p style="font-size:24px;font-weight:700;color:var(--primary)">${fmtPrice(payData.amount)}</p>
                    </div>

                    <div id="payment-error"></div>

                    <div class="form-group">
                        <label>Carte bancaire</label>
                        <div id="stripe-element"></div>
                    </div>

                    <button class="btn btn-primary btn-block btn-lg" id="pay-btn" onclick="processWalkinPayment()" disabled>
                        <i class="fas fa-lock"></i> Payer ${fmtPrice(payData.amount)}
                    </button>

                    <p style="text-align:center;font-size:12px;color:var(--gray-400);margin-top:12px">
                        <i class="fas fa-shield-alt"></i> Paiement sécurisé par Stripe
                    </p>
                </div>
            </div>
        `;

        stripeElements = stripe.elements({ clientSecret: payData.client_secret });
        cardElement = stripeElements.create('payment');
        cardElement.mount('#stripe-element');
        cardElement.on('change', (e) => {
            document.getElementById('pay-btn').disabled = !e.complete;
        });
    }

    async function processWalkinPayment() {
        const btn = document.getElementById('pay-btn');
        const errDiv = document.getElementById('payment-error');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Traitement en cours...';
        errDiv.innerHTML = '';

        try {
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements: stripeElements,
                confirmParams: { return_url: window.location.href },
                redirect: 'if_required'
            });

            if (error) {
                errDiv.innerHTML = `<div class="alert alert-error">${esc(error.message)}</div>`;
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-lock"></i> Payer ${fmtPrice(currentReservation.remaining_amount)}`;
                return;
            }

            if (paymentIntent.status === 'succeeded') {
                const confirmRes = await apiPost(`/booking/${hotelSlug}/confirm`, {
                    reservation_id: currentReservation.id,
                    payment_intent_id: paymentIntent.id
                });
                // Room number is revealed here after payment
                showConfirmation(confirmRes.reservation);
            }
        } catch (err) {
            errDiv.innerHTML = `<div class="alert alert-error">${esc(err.message)}</div>`;
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-lock"></i> Réessayer`;
        }
    }

    // ==================== CONFIRMATION ====================

    function showConfirmation(reservation) {
        currentStep = 'confirmation';
        const r = reservation;

        document.getElementById('app').innerHTML = `
            <div class="card card-wide">
                <div class="card-body" style="text-align:center;padding:40px">
                    <div style="width:64px;height:64px;border-radius:50%;background:var(--success-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                        <i class="fas fa-check" style="font-size:28px;color:var(--success)"></i>
                    </div>
                    <h2 style="color:var(--success);margin-bottom:4px">Paiement confirmé !</h2>
                    <p style="color:var(--gray-500)">Votre check-in est validé. Bon séjour !</p>

                    <div class="locker-display">
                        <p style="font-size:14px;opacity:0.8">Votre casier</p>
                        <div class="locker-number">${esc(r.locker_number || '-')}</div>
                        <p style="font-size:14px;opacity:0.8;margin-top:8px">Code d'accès</p>
                        <div class="locker-code">${esc(r.locker_code || '-')}</div>
                        <div class="room-info">
                            <i class="fas fa-bed"></i> Chambre <strong>${esc(r.room_number || '-')}</strong>
                        </div>
                    </div>

                    <div class="info-box" style="text-align:left">
                        <h4 style="margin-bottom:8px"><i class="fas fa-receipt"></i> Récapitulatif</h4>
                        <table class="summary-table">
                            <tr><td>Réservation</td><td>${esc(r.reservation_number)}</td></tr>
                            <tr><td>Client</td><td>${esc((r.guest_first_name || '') + ' ' + (r.guest_last_name || ''))}</td></tr>
                            <tr><td>Hébergement</td><td>${fmtPrice(r.accommodation_price)}</td></tr>
                            <tr><td>Taxe de séjour</td><td>${fmtPrice(r.tourist_tax_amount)}</td></tr>
                            ${r.breakfast_included ? `<tr><td>Petit-déjeuner <i class="fas fa-check-circle" style="color:var(--success)"></i></td><td>${fmtPrice(r.breakfast_price)}</td></tr>` : ''}
                            <tr class="total"><td>Total payé</td><td>${fmtPrice(r.total_amount)}</td></tr>
                            ${r.deposit_amount > 0 ? `<tr class="deposit"><td>Dont arrhes</td><td>${fmtPrice(r.deposit_amount)}</td></tr>` : ''}
                        </table>
                        <p style="font-size:12px;color:var(--gray-500);margin-top:8px">${esc(r.hotel_name)} - ${esc(r.hotel_address || '')}, ${esc(r.hotel_city || '')}</p>
                    </div>

                    ${r.guest_email ? `
                    <div class="info-box success">
                        <p><i class="fas fa-envelope"></i> Une confirmation a été envoyée à <strong>${esc(r.guest_email)}</strong></p>
                    </div>` : ''}

                    <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="downloadReceipt()">
                            <i class="fas fa-file-pdf"></i> Télécharger le reçu
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimer
                        </button>
                    </div>

                    <div style="margin-top:32px;padding-top:24px;border-top:1px solid var(--gray-200)">
                        <p style="font-size:24px">Bon séjour ! &#127969;</p>
                    </div>
                </div>
            </div>
        `;

        window._confirmationData = r;
    }

    // ==================== PDF RECEIPT ====================

    function downloadReceipt() {
        const r = window._confirmationData;
        if (!r) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text('RECU DE PAIEMENT', 105, 25, { align: 'center' });

        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.text(r.hotel_name || '', 105, 35, { align: 'center' });
        doc.setFontSize(10);
        doc.text((r.hotel_address || '') + ', ' + (r.hotel_city || ''), 105, 42, { align: 'center' });

        doc.setLineWidth(0.5);
        doc.line(20, 48, 190, 48);

        let y = 58;
        const addLine = (label, value) => {
            doc.setFont('helvetica', 'normal');
            doc.text(label, 25, y);
            doc.setFont('helvetica', 'bold');
            doc.text(String(value), 185, y, { align: 'right' });
            y += 8;
        };

        doc.setFontSize(11);
        addLine('Reservation :', r.reservation_number || '');
        addLine('Client :', (r.guest_first_name || '') + ' ' + (r.guest_last_name || ''));
        addLine("Date d'arrivee :", r.checkin_date || '');
        addLine('Chambre :', r.room_number || '');
        addLine('Casier :', (r.locker_number || '') + ' (Code: ' + (r.locker_code || '') + ')');

        y += 5;
        doc.line(20, y, 190, y);
        y += 10;

        doc.setFontSize(11);
        addLine('Hebergement :', fmtPrice(r.accommodation_price));
        addLine('Taxe de sejour :', fmtPrice(r.tourist_tax_amount));
        if (r.breakfast_included) {
            addLine('Petit-dejeuner :', fmtPrice(r.breakfast_price));
        }

        y += 3;
        doc.line(20, y, 190, y);
        y += 8;

        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.text('TOTAL :', 25, y);
        doc.text(fmtPrice(r.total_amount), 185, y, { align: 'right' });
        y += 8;

        if (r.deposit_amount > 0) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Arrhes versees :', 25, y);
            doc.text('- ' + fmtPrice(r.deposit_amount), 185, y, { align: 'right' });
            y += 8;
            doc.setFont('helvetica', 'bold');
            doc.text('Paye ce jour :', 25, y);
            doc.text(fmtPrice(r.remaining_amount), 185, y, { align: 'right' });
            y += 8;
        }

        y += 10;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('Date : ' + new Date().toLocaleDateString('fr-FR') + ' ' + new Date().toLocaleTimeString('fr-FR'), 25, y);
        y += 6;
        doc.text('Paiement par carte bancaire (Stripe)', 25, y);
        y += 12;
        doc.text('Merci et bon sejour !', 105, y, { align: 'center' });

        doc.save(`recu-${r.reservation_number || 'checkin'}.pdf`);
    }

    // ==================== START ====================
    init();
    </script>
</body>
</html>
